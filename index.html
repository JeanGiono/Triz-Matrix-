<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人行程表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f8fafc; /* 更淡的背景色 slate-50 */
        }
        .calendar-day {
            min-height: 100px;
            transition: background-color 0.3s;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .calendar-day:hover {
            background-color: #f0f9ff; /* Light blue hover */
        }
        .itinerary-item-display {
            font-size: 0.7rem; padding: 2px; margin-top: 2px;
            background-color: #e9ecef; border-radius: 3px; text-align: left;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 95%;
        }
        .itinerary-item-display p { margin: 0 0 2px 0; }
        .itinerary-item-display ul, .itinerary-item-display ol { margin: 0 0 2px 1em; padding-left: 1em;}
        .itinerary-item-display li { margin-bottom: 1px; }

        .itinerary-item-count {
            position: absolute; top: 2px; right: 2px; font-size: 0.65rem;
            background-color: #60a5fa; color: white; padding: 1px 4px;
            border-radius: 50%; line-height: 1;
        }
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center; padding: 1rem;
        }
        .modal-content { /* General modal content style */
            background-color: #ffffff; margin: auto; padding: 20px;
            border: none; /* Removed border for a cleaner look */
            width: 90%; max-width: 500px; /* Slightly narrower for modern feel */
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); /* Softer shadow */
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; /* slate-200 */
        }
        .modal-title {
            font-size: 1.25rem; /* text-xl */ font-weight: 600; /* font-semibold */ color: #1f2937; /* gray-800 */
        }
        .close-button { /* Adjusted close button */
            color: #9ca3af; /* gray-400 */ background: none; border: none;
            font-size: 1.75rem; line-height: 1; padding: 0.25rem;
            cursor: pointer; transition: color 0.2s;
        }
        .close-button:hover { color: #374151; /* gray-700 */ }

        .modal-content::-webkit-scrollbar, #itineraryItemsList::-webkit-scrollbar, #dayTooltipContent::-webkit-scrollbar, #searchResultsList::-webkit-scrollbar, #dayViewEventsList::-webkit-scrollbar { width: 6px; }
        .modal-content::-webkit-scrollbar-track, #itineraryItemsList::-webkit-scrollbar-track, #dayTooltipContent::-webkit-scrollbar-track, #searchResultsList::-webkit-scrollbar-track, #dayViewEventsList::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb, #itineraryItemsList::-webkit-scrollbar-thumb, #dayTooltipContent::-webkit-scrollbar-thumb, #searchResultsList::-webkit-scrollbar-thumb, #dayViewEventsList::-webkit-scrollbar-thumb { background: #cbd5e1; /* slate-300 */ border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb:hover, #itineraryItemsList::-webkit-scrollbar-thumb:hover, #dayTooltipContent::-webkit-scrollbar-thumb:hover, #searchResultsList::-webkit-scrollbar-thumb:hover, #dayViewEventsList::-webkit-scrollbar-thumb:hover { background: #94a3b8; /* slate-400 */ }
        
        .custom-alert {
            display: none; position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%); padding: 15px; border: 1px solid;
            border-radius: 8px; z-index: 1050; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 300px; text-align: center;
        }
        .custom-alert.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;}
        .custom-alert.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .custom-alert.loading { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .custom-alert.info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .hidden { display: none !important; }
        .holiday-info { font-size: 0.7rem; line-height: 1; word-break: break-all; margin-top: auto; text-align: center; padding-top: 2px; }
        .day-content-wrapper { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-start; overflow: hidden; }
        
        /* Management Modal Specific Styles */
        #managementModal .modal-content { max-width: 550px; }
        .management-section { margin-bottom: 1.5rem; }
        .management-section-title {
            font-size: 0.875rem; /* text-sm */ font-weight: 500; /* font-medium */
            color: #4b5563; /* gray-600 */ margin-bottom: 0.5rem;
        }
        .management-button { /* Base style for management buttons */
            display: block; width: 100%; text-align: center;
            padding: 0.75rem 1rem; border-radius: 0.5rem; /* rounded-lg */
            font-weight: 500; color: white; transition: background-color 0.2s;
            margin-bottom: 0.5rem; border: none;
        }
        .management-button.orange { background-color: #f97316; /* orange-500 */ }
        .management-button.orange:hover { background-color: #ea580c; /* orange-600 */ }
        .management-button.cyan { background-color: #06b6d4; /* cyan-500 */ }
        .management-button.cyan:hover { background-color: #0891b2; /* cyan-600 */ }
        .management-button.blue { background-color: #3b82f6; /* blue-500 */ }
        .management-button.blue:hover { background-color: #2563eb; /* blue-600 */ }
        .management-button.red { background-color: #ef4444; /* red-500 */ }
        .management-button.red:hover { background-color: #dc2626; /* red-600 */ }

        .file-input-wrapper { display: flex; align-items: center; gap: 0.5rem; }
        .file-input-button {
            background-color: #60a5fa; /* blue-400 */ color: white;
            padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem;
            cursor: pointer; transition: background-color 0.2s;
        }
        .file-input-button:hover { background-color: #3b82f6; /* blue-500 */ }
        .file-input-text { color: #6b7280; /* gray-500 */ font-size: 0.875rem; }
        #holidayFileImport { display: none; } /* Hide default file input */

        /* Itinerary Item Modal Specific Styles */
        #itineraryItemModal .modal-content { padding-top: 1rem; } /* Less top padding if header is present */
        .itinerary-modal-item {
            display: flex; justify-content: space-between; align-items: flex-start; padding: 8px;
            border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 6px;
            background-color: #f8f9fa; cursor: grab;
        }
        .itinerary-modal-item.dragging { opacity: 0.5; background-color: #dbeafe; }
        .drag-over { border-top: 2px dashed #3b82f6; }
        .itinerary-modal-item .item-details { flex-grow: 1; margin-right: 8px; }
        .itinerary-modal-item .item-description { word-break: break-word; font-weight: 500; }
        .itinerary-modal-item .item-description p:first-child { margin-top: 0; }
        .itinerary-modal-item .item-description p:last-child { margin-bottom: 0; }
        .itinerary-modal-item .item-time { font-size: 0.75rem; color: #4b5563; }
        .itinerary-modal-item .item-location { font-size: 0.75rem; color: #16a34a; margin-top: 2px; }
        .itinerary-modal-item .item-tags { font-size: 0.7rem; color: #1d4ed8; margin-top: 2px; }
        .itinerary-modal-item .item-tags .tag { background-color: #e0e7ff; padding: 1px 4px; border-radius: 3px; margin-right: 3px; display: inline-block;}
        .itinerary-modal-item .item-actions { display: flex; flex-direction: column; gap: 4px; }
        .itinerary-modal-item .item-actions button {
            background-color: transparent; border: 1px solid #d1d5db;
            color: #4b5563; padding: 4px; border-radius: 0.25rem;
            transition: all 0.2s; font-size: 0.8rem; line-height: 1;
        }
        .itinerary-modal-item .item-actions button:hover { background-color: #e5e7eb; color: #1f2937; }
        .itinerary-modal-item .item-actions .delete-btn:hover { background-color: #fee2e2; color: #b91c1c; border-color: #fecaca; }

        .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
        .form-input, .form-textarea {
            width: 100%; padding: 0.625rem 0.75rem; /* py-2.5 px-3 */
            border: 1px solid #d1d5db; /* gray-300 */ border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; color: #1f2937; /* gray-800 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none; border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); /* blue-500 with opacity */
        }
        .form-textarea { min-height: 80px; }
        .time-input-group { display: flex; gap: 1rem; margin-top: 0.75rem; margin-bottom: 0.75rem; }
        .time-input-group > div { flex: 1; }
        .add-item-button { /* Style for "Add items" like button */
            display: flex; align-items: center; justify-content: center;
            width: 100%; padding: 0.75rem 1rem; margin-top: 1rem;
            background-color: #2563eb; /* blue-600 */ color: white;
            border: none; border-radius: 0.5rem; font-weight: 500;
            font-size: 0.875rem; cursor: pointer; transition: background-color 0.2s;
        }
        .add-item-button i { margin-right: 0.5rem; }
        .add-item-button:hover { background-color: #1d4ed8; /* blue-700 */ }
        .item-modal-section { margin-bottom: 1rem; }


        #dayTooltip { position: absolute; display: none; background-color: white; border: 1px solid #cbd5e1; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); padding: 0.75rem; z-index: 50; width: 280px; max-height: 220px; }
        #dayTooltipContent { max-height: 180px; overflow-y: auto; }
        .tooltip-item { font-size: 0.8rem; padding: 0.25rem 0; border-bottom: 1px solid #e5e7eb; }
        .tooltip-item:last-child { border-bottom: none; }
        .tooltip-item .item-time { font-weight: 600; color: #374151; margin-right: 0.25rem; }
        .tooltip-item .item-description { color: #4b5563; }
        .tooltip-item .item-description p:first-child { margin-top: 0; }
        .tooltip-item .item-description p:last-child { margin-bottom: 0; }
        .tooltip-item .item-location-tooltip { font-size: 0.75rem; color: #16a34a; margin-top: 1px; }
        .tooltip-item .item-tags-tooltip { font-size: 0.7rem; color: #1d4ed8; margin-top: 1px; }
        .tooltip-item .item-tags-tooltip .tag { background-color: #e0e7ff; padding: 1px 4px; border-radius: 3px; margin-right: 3px; display: inline-block;}
        .tooltip-no-items { font-size: 0.8rem; color: #6b7280; }
        
        #searchResultsModal .modal-content { max-width: 700px; }
        .search-result-item { padding: 0.5rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; }
        .search-result-item:hover { background-color: #f9fafb; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-date { font-weight: 600; color: #1e3a8a; margin-bottom: 0.25rem; }
        .search-result-description p { margin: 0.1rem 0;}

        #dayViewContainer {
            background-color: #f9fafb; padding: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 1rem;
        }
        #dayViewDateTitle {
            font-size: 1.75rem; font-weight: 700; color: #1e3a8a; margin-bottom: 1rem;
            padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;
        }
        #dayViewEventsList { max-height: 60vh; overflow-y: auto; padding-right: 0.5rem; }
        .day-view-item {
            background-color: white; border: 1px solid #e2e8f0; border-radius: 0.375rem;
            padding: 1rem; margin-bottom: 0.75rem; display: flex;
            justify-content: space-between; align-items: flex-start; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .day-view-item .item-details { flex-grow: 1; margin-right: 1rem; }
        .day-view-item .item-description { font-size: 0.95rem; color: #374151; }
        .day-view-item .item-description p { margin: 0.25rem 0; }
        .day-view-item .item-time { font-size: 0.85rem; color: #059669; font-weight: 500; margin-bottom: 0.25rem; }
        .day-view-item .item-location { font-size: 0.85rem; color: #4f46e5; margin-top: 0.25rem; }
        .day-view-item .item-tags { font-size: 0.8rem; color: #0284c7; margin-top: 0.25rem; }
        .day-view-item .item-tags .tag { background-color: #e0f2fe; padding: 2px 6px; border-radius: 4px; margin-right: 4px; display: inline-block;}
        .day-view-item .item-actions { display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; }
        .day-view-item .item-actions button {
            background-color: #f3f4f6; border: 1px solid #d1d5db;
            color: #374151; padding: 0.375rem 0.75rem; font-size: 0.8rem;
            border-radius: 0.375rem; transition: all 0.2s;
        }
        .day-view-item .item-actions button:hover { background-color: #e5e7eb; border-color: #9ca3af; }
        .day-view-item .item-actions .delete-btn:hover { background-color: #fee2e2; color: #b91c1c; border-color: #fecaca; }

        .day-view-no-items { text-align: center; padding: 2rem; font-size: 1rem; color: #6b7280; }
        .day-view-controls { margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .day-view-controls button, .general-action-button {
            background-color: #4f46e5; color: white;
            padding: 0.625rem 1.25rem; font-size: 0.875rem; font-weight: 500;
            border-radius: 0.375rem; transition: background-color 0.2s; border: none;
        }
        .day-view-controls button:hover, .general-action-button:hover { background-color: #4338ca; }
        .day-view-controls .secondary-action-button, .general-secondary-button {
            background-color: #e5e7eb; color: #374151;
        }
        .day-view-controls .secondary-action-button:hover, .general-secondary-button:hover { background-color: #d1d5db; }
         .danger-action-button { background-color: #ef4444; color: white; }
        .danger-action-button:hover { background-color: #dc2626; }

        .day-number-span {
            display: inline-block; text-align: center;
            line-height: 1.75rem; min-width: 1.75rem;
        }
        .today .day-number-span {
            background-color: #38bdf8; color: white !important; border-radius: 50%;
            width: 1.75rem; height: 1.75rem; display: inline-flex;
            align-items: center; justify-content: center; font-weight: bold;
            position: relative; z-index: 1;
        }
        .calendar-day.weekend .day-number-span { color: #ef4444; }
        .calendar-header.weekend-header { color: #ef4444; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="customAlert" class="custom-alert">
        <span id="customAlertMessage"></span>
    </div>

    <div id="dayTooltip">
        <div id="dayTooltipContent"></div>
    </div>

    <main class="container mx-auto p-4">
        <header class="mb-6 p-3 md:p-4 bg-white shadow-md rounded-lg">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-calendar-check text-sky-700 text-2xl md:text-3xl mr-2"></i>
                    <h1 id="mainTitle" class="text-xl md:text-2xl font-bold text-sky-700 hidden sm:block">個人行程表</h1>
                </div>
                <div id="monthControls" class="flex items-center space-x-1 sm:space-x-2">
                    <button type="button" onclick="Calendar.changeMonth(-1)" class="bg-slate-100 hover:bg-slate-200 text-slate-700 p-2 rounded-full transition-colors" aria-label="上個月">
                        <i class="fas fa-chevron-left text-xs sm:text-sm"></i>
                    </button>
                    <h2 id="monthYearDisplay" class="text-base sm:text-lg md:text-xl font-bold text-sky-700 whitespace-nowrap px-1 sm:px-2" aria-live="polite"></h2>
                    <button type="button" onclick="Calendar.changeMonth(1)" class="bg-slate-100 hover:bg-slate-200 text-slate-700 p-2 rounded-full transition-colors" aria-label="下個月">
                        <i class="fas fa-chevron-right text-xs sm:text-sm"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-1 sm:space-x-2 md:space-x-3">
                    <button id="toggleSearchButton" type="button" class="text-slate-600 hover:text-sky-700 p-2 rounded-full transition-colors" aria-label="搜尋">
                        <i class="fas fa-search text-base md:text-lg"></i>
                    </button>
                    <button id="openNotificationPanelButton" type="button" class="text-slate-600 hover:text-sky-700 p-2 rounded-full transition-colors" aria-label="通知">
                        <i class="fas fa-bell text-base md:text-lg"></i>
                    </button>
                    <button id="openManagementModalButton" type="button" class="text-slate-600 hover:text-sky-700 p-2 rounded-full transition-colors" aria-label="設定">
                        <i class="fas fa-cog text-base md:text-lg"></i>
                    </button>
                </div>
            </div>
            <div id="searchBarContainer" class="mt-3 hidden">
                <input type="search" id="searchInput" placeholder="搜尋行程描述、標籤、地點..." class="w-full p-2 border border-slate-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
            </div>
        </header>

        <section id="calendarViewSection" class="bg-white p-6 shadow-lg rounded-lg" aria-labelledby="calendar-section-title">
            <h2 id="calendar-section-title" class="sr-only">行程表日曆與控制區域</h2>
            <div id="calendarGrid" class="grid grid-cols-7 gap-1" aria-labelledby="monthYearDisplay"></div>
            <div id="itineraryControls" class="mt-6">
                <form onsubmit="event.preventDefault();"> <div>
                         <label for="scheduleNotes" class="form-label">行程表備註 (本月):</label>
                         <textarea id="scheduleNotes" rows="3" class="form-textarea" placeholder="例如：5月重要會議、團隊活動"></textarea>
                         <button id="saveNotesButton" type="button" class="mt-2 general-action-button bg-emerald-500 hover:bg-emerald-600">儲存備註</button> </div>
                </form>
                <div class="mt-6 text-right">
                    <button id="exportItineraryButton" type="button" onclick="Exporter.exportItineraryToICS()" class="general-action-button bg-green-600 hover:bg-green-700">匯出行程表至 Google 日曆 (.ics)</button>
                </div>
            </div>
        </section>

        <section id="dayViewContainer" class="hidden" aria-labelledby="dayViewDateTitle">
            <h2 id="dayViewDateTitle" class="text-2xl font-bold text-sky-800 mb-4"></h2>
            <div id="dayViewEventsList" class="space-y-3 mb-6"></div>
            <div class="day-view-controls">
                <button id="addNewItemInDayViewButton" type="button" class="general-action-button bg-green-500 hover:bg-green-600">
                    <i class="fas fa-plus mr-2"></i>新增本日行程
                </button>
                <button id="backToCalendarViewButton" type="button" class="general-secondary-button">
                    <i class="fas fa-calendar-alt mr-2"></i>返回月曆檢視
                </button>
            </div>
        </section>
    </main>

    <!-- Management Modal -->
    <div id="managementModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="managementModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="managementModalTitle" class="modal-title">設定</h3>
                <button id="closeManagementModalButton" class="close-button" aria-label="關閉">&times;</button>
            </div>
            <div id="itineraryManagementContent">
                <div class="management-section">
                    <label for="fullSchedulePasteArea" class="form-label">貼上行程表文字 (簡易格式)</label>
                    <textarea id="fullSchedulePasteArea" rows="5" class="form-textarea" placeholder="每行一個行程項目，或包含日期 (如 5/15 會議)。支援 Markdown。"></textarea>
                    <button type="button" onclick="ScheduleParser.triggerImportScheduleFromPastedText()" class="management-button orange mt-2">匯入貼上之文字</button>
                </div>
                
                <div class="management-section">
                   <label class="form-label">匯入假期檔案 (.ics)</label>
                   <div class="file-input-wrapper">
                       <label for="holidayFileImport" class="file-input-button">選擇檔案</label>
                       <span id="holidayFileName" class="file-input-text">未選擇任何檔案</span>
                   </div>
                   <input type="file" id="holidayFileImport" accept=".ics" onchange="UI.updateHolidayFileName()">
                   <button type="button" onclick="HolidayImporter.triggerHolidayImport()" class="management-button cyan mt-2">匯入假期</button>
               </div>

                <div class="management-section">
                    <h3 class="management-section-title">行程表儲存與清除</h3>
                    <button id="saveItineraryButton" type="button" class="management-button blue">儲存目前行程表</button>
                    <button id="clearItineraryButton" type="button" class="management-button red">清除本月行程表</button>
                </div>
                <p class="text-xs text-slate-500 mt-4 text-center">注意：行程表資料將儲存在您的瀏覽器中。</p>
            </div>
        </div>
    </div>

    <!-- Itinerary Item Modal -->
    <div id="itineraryItemModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="itineraryItemModalTitleNew">
        <div class="modal-content">
             <div class="modal-header">
                <h3 id="itineraryItemModalTitleNew" class="modal-title">新增行程</h3>
                <button class="close-button" onclick="UI.closeItineraryItemModal()" aria-label="關閉">&times;</button>
            </div>

            <div id="itineraryItemsListContainer" class="item-modal-section max-h-40 overflow-y-auto mb-3">
                 <label class="form-label">本日已存在項目:</label>
                 <div id="itineraryItemsList" data-date="" class="space-y-1">
                    <!-- Items for the selected date in the modal -->
                 </div>
            </div>
            
            <div class="item-modal-section">
                <label for="newItineraryItemText" class="form-label">行程名稱 (支援 Markdown):</label>
                <textarea id="newItineraryItemText" rows="3" class="form-textarea" placeholder="輸入行程描述..."></textarea>
            </div>

            <div class="item-modal-section">
                <label class="form-label">時間設定</label>
                <div class="time-input-group">
                    <div>
                        <label for="itineraryStartTime" class="text-xs font-medium text-slate-500 mb-1">開始時間</label>
                        <input type="time" id="itineraryStartTime" class="form-input">
                    </div>
                    <div>
                        <label for="itineraryEndTime" class="text-xs font-medium text-slate-500 mb-1">結束時間</label>
                        <input type="time" id="itineraryEndTime" class="form-input">
                    </div>
                </div>
            </div>

            <div class="item-modal-section">
                <label for="itineraryItemLocation" class="form-label">地點 (選填):</label>
                <input type="text" id="itineraryItemLocation" class="form-input" placeholder="例如：會議室 A, 公司">
            </div>

            <div class="item-modal-section">
                <label for="itineraryItemTags" class="form-label">標籤 (以逗號分隔, 選填):</label>
                <input type="text" id="itineraryItemTags" class="form-input" placeholder="例如：工作,重要,會議">
            </div>
            
            <button id="addOrUpdateItineraryItemButton" type="button" class="add-item-button">
                <i class="fas fa-plus"></i><span id="modalSubmitButtonText">新增項目</span>
            </button>
        </div>
    </div>

    <!-- Search Results Modal -->
    <div id="searchResultsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="searchResultsModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="searchResultsModalTitle" class="modal-title">搜尋結果</h3>
                <button id="closeSearchResultsModalButton" class="close-button" aria-label="關閉">&times;</button>
            </div>
            <div id="searchResultsList" class="max-h-[60vh] overflow-y-auto pt-2">
                <!-- Search results will be populated here -->
            </div>
        </div>
    </div>

    <script>
    // AppState
    let AppState = {
        currentYear: new Date().getFullYear(), currentMonth: new Date().getMonth(),
        shifts: {}, notes: '', selectedDateForAssignment: null, holidays: {},
        editingItemId: null, draggedItemId: null, tooltipTimeout: null,
        currentView: 'calendar', 
        selectedDayForDayView: null
    };

    // UIElements
    const UIElements = {
        mainTitle: null, monthYearDisplay: null, calendarGrid: null,
        fullSchedulePasteArea: null, 
        itineraryItemModal: null, itineraryItemsList: null, newItineraryItemText: null, 
        itineraryStartTime: null, itineraryEndTime: null, itineraryItemTags: null, itineraryItemLocation: null,
        addOrUpdateItineraryItemButton: null, modalSubmitButtonText: null, itineraryItemModalTitleNew: null,
        itineraryItemsListContainer: null,
        scheduleNotesTextarea: null, customAlertBox: null, customAlertMessageBox: null, saveNotesButton: null,
        itineraryControls: null, exportItineraryButton: null,
        saveItineraryButton: null, clearItineraryButton: null,
        managementModal: null, openManagementModalButton: null, closeManagementModalButton: null,
        itineraryManagementContent: null, holidayFileName: null,
        dayTooltip: null, dayTooltipContent: null,
        searchInput: null, 
        searchBarContainer: null, monthControls: null,
        searchResultsModal: null, searchResultsList: null, closeSearchResultsModalButton: null,
        calendarViewSection: null, dayViewContainer: null, dayViewDateTitle: null, dayViewEventsList: null,
        addNewItemInDayViewButton: null, backToCalendarViewButton: null,
        toggleSearchButton: null, openNotificationPanelButton: null
    };

    // Utils
    const Utils = {
        showCustomAlert: (message, type = 'error', duration = 3500) => {
            if (!UIElements.customAlertBox || !UIElements.customAlertMessageBox) return;
            UIElements.customAlertMessageBox.textContent = message;
            UIElements.customAlertBox.className = 'custom-alert'; 
            UIElements.customAlertBox.classList.add(type);
            UIElements.customAlertBox.style.display = 'block';
            if (duration > 0) {
                setTimeout(() => { if(UIElements.customAlertBox) UIElements.customAlertBox.style.display = 'none'; }, duration);
            }
        },
        hideCustomAlert: () => {
            if (UIElements.customAlertBox) UIElements.customAlertBox.style.display = 'none';
        },
        getLocalStorageKey: (dataType, year = AppState.currentYear, month = AppState.currentMonth) => {
            const version = "v3.31_modal_style"; // Updated version
            if (dataType === 'holidays_all') {
               return `personalItinerary_${version}_holidays_all`;
            }
            return `personalItinerary_${version}_${dataType}_${year}_${String(month + 1).padStart(2, '0')}`;
        },
        generateUUID: () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (r => (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16))(Math.random() * 16 | 0))
    };

    // DataStorage (no changes)
    const DataStorage = {
        loadDataForCurrentMonth:()=>{try{const e=localStorage.getItem(Utils.getLocalStorageKey("shifts")),t=e?JSON.parse(e):{};AppState.shifts={};for(const s in t)Array.isArray(t[s])?AppState.shifts[s]=t[s].map((e=>({id:e.id||Utils.generateUUID(),description:e.description||"",startTime:e.startTime||"",endTime:e.endTime||"",tags:Array.isArray(e.tags)?e.tags:[],location:e.location||""}))):AppState.shifts[s]=[{id:Utils.generateUUID(),description:String(t[s]),startTime:"",endTime:"",tags:[],location:""}];const s=localStorage.getItem(Utils.getLocalStorageKey("notes"));AppState.notes=s||"",UIElements.scheduleNotesTextarea&&(UIElements.scheduleNotesTextarea.value=AppState.notes);const o=localStorage.getItem(Utils.getLocalStorageKey("holidays_all"));AppState.holidays=o?JSON.parse(o):{}}catch(e){console.error("Error loading data:",e),Utils.showCustomAlert("讀取資料時發生錯誤。","error")}},
        saveDataForCurrentMonth:()=>{try{localStorage.setItem(Utils.getLocalStorageKey("shifts"),JSON.stringify(AppState.shifts)),localStorage.setItem(Utils.getLocalStorageKey("notes"),AppState.notes),localStorage.setItem(Utils.getLocalStorageKey("holidays_all"),JSON.stringify(AppState.holidays))}catch(e){console.error("Error saving data:",e),Utils.showCustomAlert("儲存資料時發生錯誤。","error")}},
        clearCurrentMonthItinerary:()=>{const e=`${AppState.currentYear}-${String(AppState.currentMonth+1).padStart(2,"0")}`;let t=!1;for(const s in AppState.shifts)s.startsWith(e)&&(AppState.shifts[s]&&AppState.shifts[s].length>0&&(t=!0),delete AppState.shifts[s]);AppState.notes="",UIElements.scheduleNotesTextarea&&(UIElements.scheduleNotesTextarea.value=""),DataStorage.saveDataForCurrentMonth(),Calendar.render(),AppState.currentView==="day"&&AppState.selectedDayForDayView&&AppState.selectedDayForDayView.startsWith(e)&&DayView.renderDayViewItems(AppState.selectedDayForDayView),Utils.showCustomAlert(t||""===AppState.notes?`已清除 ${AppState.currentYear}年 ${AppState.currentMonth+1}月 的行程表資料與備註。`:`${AppState.currentYear}年 ${AppState.currentMonth+1}月 的行程表無資料可清除。`,t||""===AppState.notes?"success":"info")}
    };
    
    // HolidayImporter (no changes)
    const HolidayImporter = { 
        parseICS:e=>{const t=e.split(/\r\n|\n|\r/);let s=!1,o={DTSTART_val:null,DTEND_val:null,SUMMARY_val:null},a={};const n=e=>{if(!e)return null;const t=e.substring(e.indexOf(":")+1),s=t.includes("VALUE=DATE:")?t.substring("VALUE=DATE:".length):t;if(s.length<8)return null;const o=parseInt(s.substring(0,4)),n=parseInt(s.substring(4,6))-1,r=parseInt(s.substring(6,8));return isNaN(o)||isNaN(n)||isNaN(r)||n<0||n>11||r<1||r>31?(console.warn("Invalid date parsed from ICS:",s),null):new Date(Date.UTC(o,n,r))},r=e=>{if(!e)return null;const t=e.getUTCFullYear(),s=String(e.getUTCMonth()+1).padStart(2,"0"),o=String(e.getUTCDate()).padStart(2,"0");return`${t}-${s}-${o}`};for(const i of t)i.toUpperCase().startsWith("BEGIN:VEVENT")?(s=!0,o={DTSTART_val:null,DTEND_val:null,SUMMARY_val:null}):i.toUpperCase().startsWith("END:VEVENT")?(s&&o.DTSTART_val&&o.SUMMARY_val&&(()=>{let e=o.DTSTART_val,t=o.DTEND_val;if(t&&!(t.getTime()<=e.getTime())){let s=new Date(e.getTime());for(;s.getTime()<t.getTime();)r(s)&&(a[r(s)]=o.SUMMARY_val),s.setUTCDate(s.getUTCDate()+1)}else r(e)&&(a[r(e)]=o.SUMMARY_val)})(),s=!1):s&&(i.toUpperCase().startsWith("DTSTART")?o.DTSTART_val=n(i):i.toUpperCase().startsWith("DTEND")?o.DTEND_val=n(i):i.toUpperCase().startsWith("SUMMARY")&&(o.SUMMARY_val=i.substring(i.indexOf(":")+1).trim()));return a},
        triggerHolidayImport:()=>{const e=document.getElementById("holidayFileImport");if(!e||!e.files||0===e.files.length)return void Utils.showCustomAlert("請先選擇一個 .ics 假期檔案。","info");const t=e.files[0],s=new FileReader;s.onload=t=>{try{const s=HolidayImporter.parseICS(t.target.result);Object.keys(s).length>0?(AppState.holidays={...AppState.holidays,...s},DataStorage.saveDataForCurrentMonth(),Calendar.render(),AppState.currentView==="day"&&AppState.selectedDayForDayView&&DayView.renderDayViewItems(AppState.selectedDayForDayView),Utils.showCustomAlert(`成功匯入 ${Object.keys(s).length} 個假期。`,"success"),e.value=""):(Utils.showCustomAlert("未在檔案中找到有效的假期事件。","info"),e.value="")}catch(t){console.error("Error parsing holiday file:",t),Utils.showCustomAlert("解析假期檔案時發生錯誤。","error"),e.value=""}},s.onerror=()=>{Utils.showCustomAlert("讀取假期檔案時發生錯誤。","error"),e.value=""},s.readAsText(t)}
    };

    // Calendar (no changes)
    const Calendar = { 
        render:()=>{if(!UIElements.monthYearDisplay||!UIElements.calendarGrid)return;UIElements.calendarGrid.innerHTML="";const e=new Date(AppState.currentYear,AppState.currentMonth,1),t=new Date(AppState.currentYear,AppState.currentMonth+1,0),s=t.getDate(),o=e.getDay();UIElements.monthYearDisplay.textContent=`${AppState.currentYear}年 ${AppState.currentMonth+1}月`;const a=["日","一","二","三","四","五","六"];a.forEach(((e,t)=>{const s=document.createElement("div");s.className="text-center font-semibold text-sm py-2 bg-slate-100 rounded-t-md",s.textContent=e,(0===t||6===t)&&s.classList.add("weekend-header"),UIElements.calendarGrid.appendChild(s)}));for(let n=0;n<o;n++){const r=document.createElement("div");r.className="calendar-day border border-slate-200 bg-slate-50 rounded-md",UIElements.calendarGrid.appendChild(r)}const i=new Date;i.setHours(0,0,0,0);for(let l=1;l<=s;l++){const d=document.createElement("div"),c=`${AppState.currentYear}-${String(AppState.currentMonth+1).padStart(2,"0")}-${String(l).padStart(2,"0")}`,m=new Date(AppState.currentYear,AppState.currentMonth,l);d.className="calendar-day border border-slate-200 p-2 rounded-md cursor-pointer",d.dataset.date=c,m.getTime()===i.getTime()&&d.classList.add("today");const u=document.createElement("span");u.className="day-number-span text-sm font-medium self-start",u.textContent=l;const h=m.getDay();(0===h||6===h)&&d.classList.add("weekend"),d.appendChild(u);const p=AppState.holidays[c];p&&(u.classList.add("font-bold"),d.classList.contains("weekend")||d.classList.add("weekend"));const f=document.createElement("div");f.className="day-content-wrapper";const g=AppState.shifts[c]||[];if(g.length>0){const y=g[0],v=document.createElement("div");v.className="itinerary-item-display";let k=y.startTime?`${y.startTime} `:"";try{k+=(void 0!==marked&&marked.parse?marked.parse(y.description||"").trim().replace(/<p>|<\/p>/g,""): (y.description||"").trim())}catch(e){k+=y.description||""}v.innerHTML=k,v.title=y.description,f.appendChild(v),g.length>1&&(()=>{const e=document.createElement("span");e.className="itinerary-item-count",e.textContent=`+${g.length-1}`,d.appendChild(e)})()}d.addEventListener("click",(e=>{e.target.closest(".itinerary-item-display")||e.target.closest(".itinerary-item-count")?UI.openItineraryItemModal(c):DayView.openDayView(c)})),d.addEventListener("mouseenter",(e=>UI.showTooltip(e,c))),d.addEventListener("mouseleave",UI.hideTooltip),d.appendChild(f),p&&(()=>{const e=document.createElement("div");e.textContent=p.charAt(0),e.title=p,e.className="holiday-info text-red-600 font-semibold",f.appendChild(e)})(),UIElements.calendarGrid.appendChild(d)}const w=o+s,S=(7-w%7)%7;for(let E=0;E<S;E++){const N=document.createElement("div");N.className="calendar-day border border-slate-200 bg-slate-50 rounded-md",UIElements.calendarGrid.appendChild(N)}},
        changeMonth:e=>{UIElements.scheduleNotesTextarea&&(AppState.notes=UIElements.scheduleNotesTextarea.value),DataStorage.saveDataForCurrentMonth(),AppState.currentMonth+=e,AppState.currentMonth<0?(AppState.currentMonth=11,AppState.currentYear--):AppState.currentMonth>11&&(AppState.currentMonth=0,AppState.currentYear++),DataStorage.loadDataForCurrentMonth(),Calendar.render()}
    };

    // ScheduleParser (no changes)
    const ScheduleParser = { 
        parseTextToIntermediateData:(e,t,s)=>{const o=e.split("\n").map((e=>e.trim()));let a=t,n=null!==s?s-1:null,r={},i="";for(let l=0;l<o.length;l++){const d=o[l],c=d.match(/(\d+)\s*年\s*(\d+)\s*月/);if(c){let e=parseInt(c[1]);e<200&&e>90&&(e+=1911),a=e,n=parseInt(c[2])-1,o.splice(l,1),l--;break}}(null===a||void 0===a||isNaN(a))&&(a=AppState.currentYear),(null===n||void 0===n||isNaN(n))&&(n=AppState.currentMonth),o.forEach((e=>{if(""===e.trim())return;const t=e.match(/^(\d{1,2}(?:\/\d{1,2})?)\s+(.+)/);if(t){const s=t[1],o=t[2].trim();let l,d;s.includes("/")?([d,l]=s.split("/").map(Number),d-=1):l=parseInt(s),d=n,isNaN(l)||l<1||l>31||isNaN(d)||d<0||d>11?i?i+="\n"+e:i=e:(()=>{const t=`${a}-${String(d+1).padStart(2,"0")}-${String(l).padStart(2,"0")}`;r[t]||(r[t]=[]),r[t].push({id:Utils.generateUUID(),description:o,startTime:"",endTime:"",tags:[],location:""})()})}else i?i+="\n"+e:i=e}));const l=Object.keys(r).length>0||i.length>0;return{success:l,parsedYear:a,parsedMonth:n,parsedShifts:r,parsedNotes:i}},
        applyParsedDataToAppState:(e,t,s,o)=>{AppState.currentYear=e,AppState.currentMonth=t;const a=`${e}-${String(t+1).padStart(2,"0")}`;for(const n in AppState.shifts)n.startsWith(a)&&delete AppState.shifts[n];for(const r in s)r.startsWith(a)&&(AppState.shifts[r]||(AppState.shifts[r]=[]),AppState.shifts[r].push(...s[r]));o&&""!==o.trim()&&(AppState.notes?AppState.notes+="\n"+o:AppState.notes=o),UIElements.scheduleNotesTextarea&&(UIElements.scheduleNotesTextarea.value=AppState.notes),DataStorage.saveDataForCurrentMonth(),Calendar.render(),Utils.showCustomAlert(`行程表已成功匯入/更新 ${e}年${t+1}月 的資料！`,"success")},
        triggerImportScheduleFromPastedText:()=>{if(!UIElements.fullSchedulePasteArea)return;const e=UIElements.fullSchedulePasteArea.value;if(!e.trim())return void Utils.showCustomAlert("請先在文字區域貼上行程表的內容。","info");const t=ScheduleParser.parseTextToIntermediateData(e,AppState.currentYear,AppState.currentMonth+1);t.success?(ScheduleParser.applyParsedDataToAppState(t.parsedYear,t.parsedMonth,t.parsedShifts,t.parsedNotes),UIElements.fullSchedulePasteArea.value=""):Utils.showCustomAlert("未能在貼上的文字中找到任何有效的行程表資料。","error")}
    };

    // UI (Updated for new modal styles and elements)
    const UI = {
        cacheDOMElements: () => {
            UIElements.mainTitle = document.getElementById('mainTitle'); UIElements.monthYearDisplay = document.getElementById('monthYearDisplay');
            UIElements.calendarGrid = document.getElementById('calendarGrid'); UIElements.fullSchedulePasteArea = document.getElementById('fullSchedulePasteArea');
            UIElements.itineraryItemModal = document.getElementById('itineraryItemModal'); UIElements.itineraryItemsList = document.getElementById('itineraryItemsList');
            UIElements.newItineraryItemText = document.getElementById('newItineraryItemText'); UIElements.itineraryStartTime = document.getElementById('itineraryStartTime');
            UIElements.itineraryEndTime = document.getElementById('itineraryEndTime'); UIElements.itineraryItemTags = document.getElementById('itineraryItemTags');
            UIElements.itineraryItemLocation = document.getElementById('itineraryItemLocation'); 
            UIElements.addOrUpdateItineraryItemButton = document.getElementById('addOrUpdateItineraryItemButton');
            UIElements.modalSubmitButtonText = document.getElementById('modalSubmitButtonText');
            UIElements.itineraryItemModalTitleNew = document.getElementById('itineraryItemModalTitleNew');
            UIElements.itineraryItemsListContainer = document.getElementById('itineraryItemsListContainer');

            UIElements.scheduleNotesTextarea = document.getElementById('scheduleNotes'); UIElements.customAlertBox = document.getElementById('customAlert');
            UIElements.customAlertMessageBox = document.getElementById('customAlertMessage'); UIElements.saveNotesButton = document.getElementById('saveNotesButton');
            UIElements.itineraryControls = document.getElementById('itineraryControls'); UIElements.exportItineraryButton = document.getElementById('exportItineraryButton');
            UIElements.saveItineraryButton = document.getElementById('saveItineraryButton'); UIElements.clearItineraryButton = document.getElementById('clearItineraryButton');
            UIElements.managementModal = document.getElementById('managementModal'); UIElements.openManagementModalButton = document.getElementById('openManagementModalButton');
            UIElements.closeManagementModalButton = document.getElementById('closeManagementModalButton'); UIElements.itineraryManagementContent = document.getElementById('itineraryManagementContent');
            UIElements.holidayFileName = document.getElementById('holidayFileName');
            
            UIElements.dayTooltip = document.getElementById('dayTooltip'); UIElements.dayTooltipContent = document.getElementById('dayTooltipContent');
            UIElements.searchInput = document.getElementById('searchInput'); UIElements.searchBarContainer = document.getElementById('searchBarContainer');
            UIElements.monthControls = document.getElementById('monthControls'); UIElements.searchResultsModal = document.getElementById('searchResultsModal');
            UIElements.searchResultsList = document.getElementById('searchResultsList'); UIElements.closeSearchResultsModalButton = document.getElementById('closeSearchResultsModalButton');
            UIElements.calendarViewSection = document.getElementById('calendarViewSection'); UIElements.dayViewContainer = document.getElementById('dayViewContainer');
            UIElements.dayViewDateTitle = document.getElementById('dayViewDateTitle'); UIElements.dayViewEventsList = document.getElementById('dayViewEventsList');
            UIElements.addNewItemInDayViewButton = document.getElementById('addNewItemInDayViewButton'); UIElements.backToCalendarViewButton = document.getElementById('backToCalendarViewButton');
            UIElements.toggleSearchButton = document.getElementById('toggleSearchButton'); UIElements.openNotificationPanelButton = document.getElementById('openNotificationPanelButton');
        },
        setActiveView: (view) => { 
            AppState.currentView = view;
            if (view === 'calendar') {
                if (UIElements.calendarViewSection) UIElements.calendarViewSection.classList.remove('hidden');
                if (UIElements.dayViewContainer) UIElements.dayViewContainer.classList.add('hidden');
                if (UIElements.mainTitle) UIElements.mainTitle.textContent = "個人行程表"; 
                Calendar.render(); 
            } else if (view === 'day') {
                if (UIElements.calendarViewSection) UIElements.calendarViewSection.classList.add('hidden');
                if (UIElements.dayViewContainer) UIElements.dayViewContainer.classList.remove('hidden');
                 if (UIElements.mainTitle) UIElements.mainTitle.textContent = "本日行程"; 
            }
        },
        updateHolidayFileName: () => {
            const fileInput = document.getElementById('holidayFileImport');
            if (UIElements.holidayFileName && fileInput && fileInput.files.length > 0) {
                UIElements.holidayFileName.textContent = fileInput.files[0].name;
            } else if (UIElements.holidayFileName) {
                UIElements.holidayFileName.textContent = '未選擇任何檔案';
            }
        },
        openItineraryItemModal: (dateStr, itemIdToEdit = null) => { 
            if (!UIElements.itineraryItemModal || !UIElements.itineraryItemsList || !UIElements.newItineraryItemText || 
                !UIElements.addOrUpdateItineraryItemButton || !UIElements.itineraryStartTime || !UIElements.itineraryEndTime || 
                !UIElements.itineraryItemTags || !UIElements.itineraryItemLocation || !UIElements.modalSubmitButtonText ||
                !UIElements.itineraryItemModalTitleNew || !UIElements.itineraryItemsListContainer) return;
            
            AppState.selectedDateForAssignment = dateStr; 
            UIElements.itineraryItemsList.dataset.date = dateStr; 
            
            const [year, month, day] = dateStr.split('-');
            const formattedDateForTitle = `${parseInt(month)}月${parseInt(day)}日`;

            UIElements.newItineraryItemText.value = ''; UIElements.itineraryStartTime.value = ''; 
            UIElements.itineraryEndTime.value = ''; UIElements.itineraryItemTags.value = ''; 
            UIElements.itineraryItemLocation.value = ''; 
            AppState.editingItemId = null; 
            
            if (itemIdToEdit) {
                UIElements.itineraryItemModalTitleNew.textContent = `編輯行程 (${formattedDateForTitle})`;
                UIElements.modalSubmitButtonText.textContent = '更新項目';
                const itemsOnDate = AppState.shifts[dateStr] || [];
                const item = itemsOnDate.find(i => i.id === itemIdToEdit);
                if (item) UI.prepareEditItineraryItem(dateStr, item); 
            } else {
                UIElements.itineraryItemModalTitleNew.textContent = `新增行程 (${formattedDateForTitle})`;
                UIElements.modalSubmitButtonText.textContent = '新增項目';
            }
            
            UI.renderItineraryItemsInModal(dateStr); 
            // Show or hide the "existing items" list based on content
            if (AppState.shifts[dateStr] && AppState.shifts[dateStr].length > 0) {
                UIElements.itineraryItemsListContainer.classList.remove('hidden');
            } else {
                UIElements.itineraryItemsListContainer.classList.add('hidden');
            }

            UIElements.itineraryItemModal.style.display = 'flex'; UIElements.newItineraryItemText.focus();
        },
        closeItineraryItemModal: () => { 
            if (UIElements.itineraryItemModal) UIElements.itineraryItemModal.style.display = 'none';
            if (AppState.currentView === 'day' && AppState.selectedDayForDayView) DayView.renderDayViewItems(AppState.selectedDayForDayView);
        },
        renderItineraryItemsInModal: (dateStr) => { 
            if (!UIElements.itineraryItemsList || !UIElements.itineraryItemsListContainer) return; 
            UIElements.itineraryItemsList.innerHTML = ''; 
            const items = [...(AppState.shifts[dateStr] || [])].sort((a,b) => (a.startTime || "23:59").localeCompare(b.startTime || "23:59"));
            
            if (items.length === 0) { 
                UIElements.itineraryItemsListContainer.classList.add('hidden'); // Hide if no items
                return;
            }
            UIElements.itineraryItemsListContainer.classList.remove('hidden'); // Show if items exist

            items.forEach(item => {
                const itemDiv = document.createElement('div'); itemDiv.className = 'itinerary-modal-item'; 
                itemDiv.setAttribute('draggable', true); itemDiv.dataset.itemId = item.id; 
                const itemDetailsDiv = document.createElement('div'); itemDetailsDiv.className = 'item-details';
                const itemDescriptionP = document.createElement('p'); itemDescriptionP.className = 'item-description';
                try { itemDescriptionP.innerHTML = (typeof marked !== 'undefined' && marked.parse) ? marked.parse(item.description || "") : (item.description || ""); } 
                catch(e) { itemDescriptionP.textContent = item.description || ""; } itemDetailsDiv.appendChild(itemDescriptionP);
                if (item.startTime || item.endTime) { const itemTimeP = document.createElement('p'); itemTimeP.className = 'item-time'; let timeText = ""; if (item.startTime) timeText += item.startTime; if (item.startTime && item.endTime) timeText += " - "; else if (!item.startTime && item.endTime) timeText += "結束於 "; if (item.endTime) timeText += item.endTime; itemTimeP.textContent = timeText; itemDetailsDiv.appendChild(itemTimeP); }
                if (item.location) { const itemLocationP = document.createElement('p'); itemLocationP.className = 'item-location'; itemLocationP.innerHTML = `<i class="fas fa-map-marker-alt mr-1"></i>${item.location}`; itemDetailsDiv.appendChild(itemLocationP); }
                if (item.tags && item.tags.length > 0) { const itemTagsDiv = document.createElement('div'); itemTagsDiv.className = 'item-tags'; item.tags.forEach(tag => { const tagSpan = document.createElement('span'); tagSpan.className = 'tag'; tagSpan.textContent = tag; itemTagsDiv.appendChild(tagSpan); }); itemDetailsDiv.appendChild(itemTagsDiv); }
                itemDiv.appendChild(itemDetailsDiv);
                const buttonGroup = document.createElement('div'); buttonGroup.className = 'item-actions';
                const editBtn = document.createElement('button'); editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>'; editBtn.title = '編輯此項目';
                editBtn.onclick = (e) => { e.stopPropagation(); UI.prepareEditItineraryItem(dateStr, item); UIElements.modalSubmitButtonText.textContent = '更新項目'; UIElements.itineraryItemModalTitleNew.textContent = `編輯行程 (${dateStr.substring(5)})`;}; buttonGroup.appendChild(editBtn);
                const deleteBtn = document.createElement('button'); deleteBtn.innerHTML = '<i class="fas fa-times"></i>'; deleteBtn.classList.add("delete-btn"); deleteBtn.title = '刪除此項目';
                deleteBtn.onclick = (e) => { e.stopPropagation(); UI.removeItineraryItem(dateStr, item.id); }; buttonGroup.appendChild(deleteBtn);
                itemDiv.appendChild(buttonGroup); UIElements.itineraryItemsList.appendChild(itemDiv);
            });
        },
        prepareEditItineraryItem: (dateStr, itemToEdit) => { 
            if (!UIElements.newItineraryItemText || !UIElements.addOrUpdateItineraryItemButton || !UIElements.itineraryStartTime || !UIElements.itineraryEndTime || !UIElements.itineraryItemTags || !UIElements.itineraryItemLocation || !UIElements.modalSubmitButtonText) return;
            AppState.editingItemId = itemToEdit.id; AppState.selectedDateForAssignment = dateStr; 
            UIElements.newItineraryItemText.value = itemToEdit.description; UIElements.itineraryStartTime.value = itemToEdit.startTime || "";
            UIElements.itineraryEndTime.value = itemToEdit.endTime || ""; UIElements.itineraryItemTags.value = itemToEdit.tags ? itemToEdit.tags.join(', ') : "";
            UIElements.itineraryItemLocation.value = itemToEdit.location || ""; 
            UIElements.modalSubmitButtonText.textContent = '更新項目'; 
            UIElements.newItineraryItemText.focus(); 
        },
        addOrUpdateItineraryItem: () => { 
            if (!AppState.selectedDateForAssignment || !UIElements.newItineraryItemText || !UIElements.itineraryStartTime || !UIElements.itineraryEndTime || !UIElements.itineraryItemTags || !UIElements.itineraryItemLocation || !UIElements.modalSubmitButtonText) return;
            const description = UIElements.newItineraryItemText.value.trim(); const startTime = UIElements.itineraryStartTime.value;
            const endTime = UIElements.itineraryEndTime.value; const tagsString = UIElements.itineraryItemTags.value.trim();
            const tags = tagsString ? tagsString.split(/[,，\s]+/).map(tag => tag.trim()).filter(tag => tag) : [];
            const location = UIElements.itineraryItemLocation.value.trim();
            if (!description) { Utils.showCustomAlert("行程描述不可為空。", "info"); return; }
            if (endTime && !startTime) { Utils.showCustomAlert("若設定結束時間，請同時設定開始時間。", "info"); return; }
            if (startTime && endTime && endTime < startTime) { Utils.showCustomAlert("結束時間不可早於開始時間。", "info"); return; }
            const dateStr = AppState.selectedDateForAssignment; if (!AppState.shifts[dateStr]) AppState.shifts[dateStr] = [];
            if (AppState.editingItemId) { 
                const itemIndex = AppState.shifts[dateStr].findIndex(item => item.id === AppState.editingItemId);
                if (itemIndex > -1) { AppState.shifts[dateStr][itemIndex].description = description; AppState.shifts[dateStr][itemIndex].startTime = startTime; AppState.shifts[dateStr][itemIndex].endTime = endTime; AppState.shifts[dateStr][itemIndex].tags = tags; AppState.shifts[dateStr][itemIndex].location = location; Utils.showCustomAlert("行程項目已更新。", "success", 1500); }
                AppState.editingItemId = null; UIElements.modalSubmitButtonText.textContent = '新增項目';
                UIElements.itineraryItemModalTitleNew.textContent = `新增行程 (${dateStr.substring(5)})`;
            } else { const newItem = { id: Utils.generateUUID(), description: description, startTime: startTime, endTime: endTime, tags: tags, location: location }; AppState.shifts[dateStr].push(newItem); Utils.showCustomAlert("行程項目已新增。", "success", 1500); }
            DataStorage.saveDataForCurrentMonth(); UI.renderItineraryItemsInModal(dateStr); 
            if (AppState.currentView === 'day' && AppState.selectedDayForDayView === dateStr) DayView.renderDayViewItems(dateStr);
            Calendar.render(); 
            if (!AppState.editingItemId) { UIElements.newItineraryItemText.value = ''; UIElements.itineraryStartTime.value = ''; UIElements.itineraryEndTime.value = ''; UIElements.itineraryItemTags.value = ''; UIElements.itineraryItemLocation.value = ''; UIElements.newItineraryItemText.focus(); }
        },
        removeItineraryItem: (dateStr, itemId) => { 
            if (!AppState.shifts[dateStr]) return; AppState.shifts[dateStr] = AppState.shifts[dateStr].filter(item => item.id !== itemId);
            if (AppState.shifts[dateStr].length === 0) {
                delete AppState.shifts[dateStr];
                if (UIElements.itineraryItemsListContainer) UIElements.itineraryItemsListContainer.classList.add('hidden'); // Hide if list becomes empty
            }
            DataStorage.saveDataForCurrentMonth();
            if (UIElements.itineraryItemModal.style.display === 'flex' && UIElements.itineraryItemsList.dataset.date === dateStr) UI.renderItineraryItemsInModal(dateStr);
            if (AppState.currentView === 'day' && AppState.selectedDayForDayView === dateStr) DayView.renderDayViewItems(dateStr);
            Calendar.render(); Utils.showCustomAlert("行程項目已刪除。", "success", 1500);
            if (AppState.editingItemId === itemId) { AppState.editingItemId = null; UIElements.newItineraryItemText.value = ''; UIElements.itineraryStartTime.value = ''; UIElements.itineraryEndTime.value = ''; UIElements.itineraryItemTags.value = ''; UIElements.itineraryItemLocation.value = ''; UIElements.modalSubmitButtonText.textContent = '新增項目'; UIElements.itineraryItemModalTitleNew.textContent = `新增行程 (${dateStr.substring(5)})`; }
        },
        openManagementModal: () => { if (UIElements.managementModal) UIElements.managementModal.style.display = 'flex'; },
        closeManagementModal: () => { if (UIElements.managementModal) UIElements.managementModal.style.display = 'none'; },
        showTooltip:(e,t)=>{if(UIElements.dayTooltip&&UIElements.dayTooltipContent){clearTimeout(AppState.tooltipTimeout);const s=AppState.shifts[t]||[];if(0===s.length&&!AppState.holidays[t])return void UI.hideTooltip(0);UIElements.dayTooltipContent.innerHTML="",AppState.holidays[t]&&(()=>{const e=document.createElement("div");e.className="tooltip-item font-semibold text-red-600",e.textContent=`假期: ${AppState.holidays[t]}`,UIElements.dayTooltipContent.appendChild(e)})(),s.length>0?(s.slice(0,3).forEach((e=>{const t=document.createElement("div");t.className="tooltip-item";let s="";e.startTime&&(s+=`<span class="item-time">${e.startTime}</span>`,e.endTime&&(s+=`<span class="item-time"> - ${e.endTime}</span>`),s+=" ");try{s+=`<span class="item-description">${void 0!==marked&&marked.parse?marked.parse(e.description||"").replace(/<p>|<\/p>/g,""):e.description||""}</span>`}catch(t){s+=`<span class="item-description">${e.description||""}</span>`}e.location&&(s+=`<div class="item-location-tooltip"><i class="fas fa-map-marker-alt mr-1"></i>${e.location}</div>`),e.tags&&e.tags.length>0&&(s+='<div class="item-tags-tooltip">',e.tags.forEach((e=>{s+=`<span class="tag">${e}</span>`})),s+="</div>"),t.innerHTML=s,UIElements.dayTooltipContent.appendChild(t)})),s.length>3&&(()=>{const e=document.createElement("div");e.className="tooltip-item text-xs text-slate-500",e.textContent=`還有 ${s.length-3} 個項目...`,UIElements.dayTooltipContent.appendChild(e)})()):AppState.holidays[t]||(()=>{const e=document.createElement("div");e.className="tooltip-no-items",e.textContent="本日無行程項目",UIElements.dayTooltipContent.appendChild(e)})();const o=e.currentTarget,a=o.getBoundingClientRect(),n=UIElements.dayTooltip;n.style.display="block";const r=n.getBoundingClientRect();let i=a.bottom+window.scrollY+5,l=a.left+window.scrollX;l+r.width>window.innerWidth&&(l=window.innerWidth-r.width-10),i+r.height>window.innerHeight&&a.top>r.height+5?i=a.top+window.scrollY-r.height-5:i+r.height>window.innerHeight&&(i=window.innerHeight-r.height-10),l<0&&(l=5),i<0&&(i=5),n.style.top=`${i}px`,n.style.left=`${l}px`}},
        hideTooltip: (delay = 100) => { if (AppState.tooltipTimeout) clearTimeout(AppState.tooltipTimeout); AppState.tooltipTimeout = setTimeout(() => { if (UIElements.dayTooltip) UIElements.dayTooltip.style.display = 'none'; }, delay); },
        openSearchResultsModal:e=>{if(UIElements.searchResultsModal&&UIElements.searchResultsList){UIElements.searchResultsList.innerHTML="",0===e.length?UIElements.searchResultsList.innerHTML='<p class="text-slate-500 p-4 text-center">找不到符合條件的行程項目。</p>':e.forEach((e=>{const t=document.createElement("div");t.className="search-result-item";let s=`<div class="search-result-date">${e.date}</div>`;e.item.startTime&&(s+=`<span class="item-time">${e.item.startTime}</span>`,e.item.endTime&&(s+=`<span class="item-time"> - ${e.item.endTime}</span>`),s+=" ");try{s+=`<div class="search-result-description">${void 0!==marked&&marked.parse?marked.parse(e.item.description||""):e.item.description||""}</div>`}catch(t){s+=`<div class="search-result-description">${e.item.description||""}</div>`}e.item.location&&(s+=`<div class="item-location-tooltip text-sm"><i class="fas fa-map-marker-alt mr-1"></i>${e.item.location}</div>`),e.item.tags&&e.item.tags.length>0&&(s+='<div class="item-tags-tooltip text-sm">',e.item.tags.forEach((e=>{s+=`<span class="tag">${e}</span>`})),s+="</div>"),t.innerHTML=s,t.onclick=()=>{UI.closeSearchResultsModal();const[t,s,o]=e.date.split("-").map(Number);AppState.currentYear===t&&AppState.currentMonth===s-1||(AppState.currentYear=t,AppState.currentMonth=s-1,DataStorage.loadDataForCurrentMonth()),DayView.openDayView(e.date)},UIElements.searchResultsList.appendChild(t)})),UIElements.searchResultsModal.style.display="flex"}},
        closeSearchResultsModal: () => { if (UIElements.searchResultsModal) UIElements.searchResultsModal.style.display = 'none'; }
    };

    // DayView Module (no changes)
    const DayView = {
        openDayView:e=>{AppState.selectedDayForDayView=e,UI.setActiveView("day"),UIElements.dayViewDateTitle&&(()=>{const[t,s,o]=e.split("-");UIElements.dayViewDateTitle.textContent=`${t}年${parseInt(s)}月${parseInt(o)}日 行程詳情`})(),DayView.renderDayViewItems(e),UIElements.addNewItemInDayViewButton&&(UIElements.addNewItemInDayViewButton.onclick=()=>UI.openItineraryItemModal(e))},
        closeDayView:()=>{UI.setActiveView("calendar"),AppState.selectedDayForDayView=null},
        renderDayViewItems:e=>{if(!UIElements.dayViewEventsList)return;UIElements.dayViewEventsList.innerHTML="";const t=[...(AppState.shifts[e]||[])].sort(((e,t)=>(e.startTime||"23:59").localeCompare(t.startTime||"23:59")));if(AppState.holidays[e]&&(()=>{const t=document.createElement("div");t.className="day-view-item bg-red-50 border-red-200",t.innerHTML=`<div class="item-details"><p class="item-description font-semibold text-red-700"><i class="fas fa-star mr-2"></i>假期: ${AppState.holidays[e]}</p></div>`,UIElements.dayViewEventsList.appendChild(t)})(),0===t.length)return void(AppState.holidays[e]||(UIElements.dayViewEventsList.innerHTML='<p class="day-view-no-items">本日無行程項目。</p>'));t.forEach((t=>{const s=document.createElement("div");s.className="day-view-item",s.dataset.itemId=t.id;const o=document.createElement("div");o.className="item-details",t.startTime&&(()=>{const e=document.createElement("p");e.className="item-time",e.textContent=t.startTime+(t.endTime?` - ${t.endTime}`:""),o.appendChild(e)})();const a=document.createElement("div");a.className="item-description";try{a.innerHTML=void 0!==marked&&marked.parse?marked.parse(t.description||""):t.description||""}catch(e){a.textContent=t.description||""}o.appendChild(a),t.location&&(()=>{const e=document.createElement("p");e.className="item-location",e.innerHTML=`<i class="fas fa-map-marker-alt mr-1"></i>${t.location}`,o.appendChild(e)})(),t.tags&&t.tags.length>0&&(()=>{const e=document.createElement("div");e.className="item-tags",t.tags.forEach((t=>{const s=document.createElement("span");s.className="tag",s.textContent=t,e.appendChild(s)})),o.appendChild(e)})(),s.appendChild(o);const n=document.createElement("div");n.className="item-actions";const r=document.createElement("button");r.innerHTML='<i class="fas fa-edit mr-1"></i>編輯',r.onclick=()=>UI.openItineraryItemModal(e,t.id),n.appendChild(r);const i=document.createElement("button");i.innerHTML='<i class="fas fa-trash-alt mr-1"></i>刪除',i.classList.add("delete-btn"),i.onclick=()=>{confirm(`確定要刪除此行程項目嗎？\n"${t.description.substring(0,50)}..."`)&&UI.removeItineraryItem(e,t.id)},n.appendChild(i),s.appendChild(n),UIElements.dayViewEventsList.appendChild(s)}))}
    };

    // DragDrop (no changes)
    const DragDrop = { 
        init:()=>{const e=UIElements.itineraryItemsList;e&&(e.addEventListener("dragstart",DragDrop.handleDragStart),e.addEventListener("dragover",DragDrop.handleDragOver),e.addEventListener("drop",DragDrop.handleDrop),e.addEventListener("dragend",DragDrop.handleDragEnd))},
        handleDragStart:e=>{const t=e.target.closest(".itinerary-modal-item");t&&t.dataset.itemId?(AppState.draggedItemId=t.dataset.itemId,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",AppState.draggedItemId),setTimeout((()=>t.classList.add("dragging")),0)):e.preventDefault()},
        handleDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="move";const t=UIElements.itineraryItemsList;if(!t)return;const s=t.querySelector(".dragging");if(!s)return;const o=[...t.querySelectorAll(".itinerary-modal-item:not(.dragging)")].find((t=>{const s=t.getBoundingClientRect();return e.clientY<s.top+s.height/2}));[...t.querySelectorAll(".itinerary-modal-item:not(.dragging)")].forEach((e=>e.classList.remove("drag-over"))),o&&o.classList.add("drag-over")},
        handleDrop:e=>{e.preventDefault();const t=UIElements.itineraryItemsList?UIElements.itineraryItemsList.dataset.date:null;if(!t||!AppState.draggedItemId)return;const s=AppState.shifts[t]||[];if(0===s.length)return;const o=s.findIndex((e=>e.id===AppState.draggedItemId));if(-1===o)return;const a=s.splice(o,1)[0];let n;const r=e.target.closest(".itinerary-modal-item:not(.dragging)");if(r&&r.dataset.itemId){const i=r.dataset.itemId;n=s.findIndex((e=>e.id===i));const l=r.getBoundingClientRect();e.clientY>=l.top+l.height/2&&n++}else{const d=UIElements.itineraryItemsList,c=d?[...d.querySelectorAll(".itinerary-modal-item:not(.dragging)")]:[],m=c.find((t=>e.clientY<t.getBoundingClientRect().top+t.getBoundingClientRect().height/2));n=m&&m.dataset.itemId?s.findIndex((e=>e.id===m.dataset.itemId)):s.length}s.splice(n,0,a),AppState.shifts[t]=s,DataStorage.saveDataForCurrentMonth(),UI.renderItineraryItemsInModal(t),Calendar.render(),AppState.currentView==="day"&&AppState.selectedDayForDayView===t&&DayView.renderDayViewItems(t)},
        handleDragEnd:e=>{const t=e.target.closest(".itinerary-modal-item");t&&t.classList.remove("dragging");const s=UIElements.itineraryItemsList;s&&[...s.querySelectorAll(".itinerary-modal-item")].forEach((e=>e.classList.remove("drag-over"))),AppState.draggedItemId=null}
    };

    // Exporter (no changes)
    const Exporter = { 
        exportItineraryToICS:()=>{let e=[];const t=`${AppState.currentYear}-${String(AppState.currentMonth+1).padStart(2,"0")}`;for(const s in AppState.shifts)s.startsWith(t)&&AppState.shifts[s]&&AppState.shifts[s].forEach((t=>{e.push({date:s,description:t.description,id:t.id,startTime:t.startTime,endTime:t.endTime,tags:t.tags,location:t.location})}));if(0===e.length)return void Utils.showCustomAlert("本月沒有行程表項目可供匯出。","info");let s=["BEGIN:VCALENDAR","VERSION:2.0",`PRODID:-//PersonalItineraryTool//${Utils.getLocalStorageKey("").split("_")[1]}//ZH`];e.forEach((e=>{const t=e.date.split("-");if(3!==t.length)return;const o=parseInt(t[0]),a=parseInt(t[1])-1,n=parseInt(t[2]);let r,i;const l=`${o}${String(a+1).padStart(2,"0")}${String(n).padStart(2,"0")}`;if(e.startTime){const d=e.startTime.replace(":","")+"00";r=`DTSTART;TZID=Asia/Taipei:${l}T${d}`,e.endTime?(()=>{const t=e.endTime.replace(":","")+"00";i=`DTEND;TZID=Asia/Taipei:${l}T${t}`})():(()=>{const t=parseInt(e.startTime.split(":")[0]),s=parseInt(e.startTime.split(":")[1]);let o=t+1,a=s;o>=24&&(o=23,a=59),i=`DTEND;TZID=Asia/Taipei:${l}T${String(o).padStart(2,"0")}${String(a).padStart(2,"0")}00`})()}else{r=`DTSTART;VALUE=DATE:${l}`;const c=new Date(Date.UTC(o,a,n+1));i=`DTEND;VALUE=DATE:${c.getUTCFullYear()}${String(c.getUTCMonth()+1).padStart(2,"0")}${String(c.getUTCDate()).padStart(2,"0")}`}let m=e.description.split("\n")[0],u=e.description;e.location&&(u+=`\n地點: ${e.location}`),e.tags&&e.tags.length>0&&(u+=`\n標籤: ${e.tags.join(", ")}`),s.push("BEGIN:VEVENT",`UID:itinerary-${e.date}-${e.id}@personaltool.local`,`DTSTAMP:${(new Date).toISOString().replace(/[-:.]/g,"").substring(0,15)}Z`,r,i,`SUMMARY:${m.replace(/\n/g,"\\n")}`,`DESCRIPTION:${u.replace(/\n/g,"\\n")}`),e.location&&s.push(`LOCATION:${e.location.replace(/\n/g,"\\n")}`),s.push("END:VEVENT")})),s.push("END:VCALENDAR");const o=s.join("\r\n"),a=new Blob([o],{type:"text/calendar;charset=utf-8"}),n=document.createElement("a");n.href=URL.createObjectURL(a),n.download=`個人行程表_${AppState.currentYear}${String(AppState.currentMonth+1).padStart(2,"0")}.ics`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(n.href),Utils.showCustomAlert("行程表已匯出為 .ics 檔案。","success")}
    };
    
    // Search Functionality (no changes)
    const Search = {
        performSearch:()=>{if(!UIElements.searchInput)return;const e=UIElements.searchInput.value.trim().toLowerCase();if(!e)return void Utils.showCustomAlert("請輸入搜尋關鍵字。","info");const t=[];for(const s in AppState.shifts)AppState.shifts.hasOwnProperty(s)&&AppState.shifts[s].forEach((o=>{let a=!1;o.description&&o.description.toLowerCase().includes(e)&&(a=!0),a||!o.location||!o.location.toLowerCase().includes(e)||(a=!0),a||!o.tags||!o.tags.some((t=>t.toLowerCase().includes(e)))||(a=!0),a&&t.push({date:s,item:{...o}})}));t.sort(((e,t)=>e.date.localeCompare(t.date))),UI.openSearchResultsModal(t)}
    };

    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
        UI.cacheDOMElements(); if (UIElements.itineraryItemsList) DragDrop.init(); 
        DataStorage.loadDataForCurrentMonth(); UI.setActiveView('calendar'); 
        if (UIElements.saveNotesButton) UIElements.saveNotesButton.addEventListener('click', () => { if (UIElements.scheduleNotesTextarea) AppState.notes = UIElements.scheduleNotesTextarea.value; DataStorage.saveDataForCurrentMonth(); Utils.showCustomAlert("備註已儲存。", "success", 2000); });
        if (UIElements.openManagementModalButton) UIElements.openManagementModalButton.addEventListener('click', UI.openManagementModal);
        if (UIElements.closeManagementModalButton) UIElements.closeManagementModalButton.addEventListener('click', UI.closeManagementModal);
        if (UIElements.saveItineraryButton) UIElements.saveItineraryButton.addEventListener('click', () => { if (UIElements.scheduleNotesTextarea) AppState.notes = UIElements.scheduleNotesTextarea.value; DataStorage.saveDataForCurrentMonth(); Utils.showCustomAlert("行程表資料已儲存。", "success"); UI.closeManagementModal(); });
        if (UIElements.clearItineraryButton) UIElements.clearItineraryButton.addEventListener('click', () => { if (confirm(`您確定要清除 ${AppState.currentYear}年 ${AppState.currentMonth + 1}月 的所有行程表資料和備註嗎？此操作無法復原。`)) DataStorage.clearCurrentMonthItinerary(); });
        if (UIElements.addOrUpdateItineraryItemButton) UIElements.addOrUpdateItineraryItemButton.addEventListener('click', UI.addOrUpdateItineraryItem);
        if (UIElements.newItineraryItemText) UIElements.newItineraryItemText.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); UI.addOrUpdateItineraryItem(); } });
        if (UIElements.toggleSearchButton && UIElements.searchBarContainer) UIElements.toggleSearchButton.addEventListener('click', () => { UIElements.searchBarContainer.classList.toggle('hidden'); if (!UIElements.searchBarContainer.classList.contains('hidden') && UIElements.searchInput) UIElements.searchInput.focus(); });
        if (UIElements.searchInput) UIElements.searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') Search.performSearch(); });
        if (UIElements.closeSearchResultsModalButton) UIElements.closeSearchResultsModalButton.addEventListener('click', UI.closeSearchResultsModal);
        if (UIElements.openNotificationPanelButton) UIElements.openNotificationPanelButton.addEventListener('click', () => Utils.showCustomAlert("通知功能尚未實作。", "info", 2000));
        if (UIElements.backToCalendarViewButton) UIElements.backToCalendarViewButton.addEventListener('click', DayView.closeDayView);
        window.addEventListener('keydown', (event) => { if (event.key === 'Escape') { if (UIElements.itineraryItemModal && UIElements.itineraryItemModal.style.display === 'flex') UI.closeItineraryItemModal(); if (UIElements.managementModal && UIElements.managementModal.style.display === 'flex') UI.closeManagementModal(); if (UIElements.searchResultsModal && UIElements.searchResultsModal.style.display === 'flex') UI.closeSearchResultsModal(); UI.hideTooltip(0); } });
        window.onclick = function(event) { if (UIElements.itineraryItemModal && event.target == UIElements.itineraryItemModal) UI.closeItineraryItemModal(); if (UIElements.managementModal && event.target == UIElements.managementModal) UI.closeManagementModal(); if (UIElements.searchResultsModal && event.target == UIElements.searchResultsModal) UI.closeSearchResultsModal(); }
        if(UIElements.calendarGrid) UIElements.calendarGrid.addEventListener('mouseleave', () => UI.hideTooltip());
        window.addEventListener('blur', () => UI.hideTooltip(0)); 
    });
    </script>
</body>
</html>
<!-- The user's original copyright notice -->
<div style="text-align: center;">
 Copyright © Jean Giono 
</div>
