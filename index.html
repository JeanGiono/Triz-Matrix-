<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人行程表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f8f9fa; 
        }
        .calendar-day {
            min-height: 100px;
            transition: background-color 0.3s;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .calendar-day:hover {
            background-color: #e9f5ff !important; 
        }
        .calendar-day.today .day-number-display {
            background-color: #007bff;
            color: white !important; /* Ensure white text for today's highlight */
            border-radius: 50%;
            width: 28px; 
            height: 28px; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .day-number-display {
            font-size: 0.875rem; 
            padding: 0.25rem; 
            align-self: flex-start;
        }

        .itinerary-item-display {
            font-size: 0.7rem;
            padding: 2px 4px;
            margin-top: 3px;
            background-color: #e0e7ff; 
            color: #3730a3; 
            border-radius: 4px;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 95%;
        }
        .itinerary-item-display p { margin: 0; }

        .itinerary-item-count {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.65rem;
            background-color: #3b82f6; 
            color: white;
            padding: 2px 5px;
            border-radius: 0.75rem; 
            line-height: 1;
        }
        .modal {
            display: none; position: fixed; z-index: 100;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6); 
            align-items: center; justify-content: center;
        }
        .modal-content { 
            background-color: #ffffff; margin: auto; padding: 24px; 
            border: none; 
            width: 90%; max-width: 500px; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15), 0 6px 10px rgba(0,0,0,0.1); 
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px; 
            margin-bottom: 16px; 
            border-bottom: 1px solid #e5e7eb; 
        }
        .modal-title {
            font-size: 1.25rem; 
            font-weight: 600; 
            color: #1f2937; 
        }
        .close-button { 
            color: #6b7280; 
            background-color: transparent;
            border: none;
            font-size: 1.75rem; 
            font-weight: bold;
            line-height: 1;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover { color: #1f2937; }

        .modal-content::-webkit-scrollbar, #itineraryItemsList::-webkit-scrollbar, #dayTooltipContent::-webkit-scrollbar, #searchResultsList::-webkit-scrollbar, #dayViewEventsList::-webkit-scrollbar { width: 6px; }
        .modal-content::-webkit-scrollbar-track, #itineraryItemsList::-webkit-scrollbar-track, #dayTooltipContent::-webkit-scrollbar-track, #searchResultsList::-webkit-scrollbar-track, #dayViewEventsList::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb, #itineraryItemsList::-webkit-scrollbar-thumb, #dayTooltipContent::-webkit-scrollbar-thumb, #searchResultsList::-webkit-scrollbar-thumb, #dayViewEventsList::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb:hover, #itineraryItemsList::-webkit-scrollbar-thumb:hover, #dayTooltipContent::-webkit-scrollbar-thumb:hover, #searchResultsList::-webkit-scrollbar-thumb:hover, #dayViewEventsList::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .custom-alert {
            display: none; position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%); padding: 16px; 
            border-radius: 8px; 
            z-index: 1050;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 320px; text-align: center;
            font-size: 0.875rem; 
        }
        .custom-alert.error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca;} 
        .custom-alert.success { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } 
        .custom-alert.info { background-color: #e0f2fe; color: #075985; border: 1px solid #bae6fd; } 
        .hidden { display: none !important; }
        .holiday-info { font-size: 0.7rem; line-height: 1; word-break: break-all; margin-top: auto; text-align: center; padding-top: 2px; color: #c2410c; }
        .day-content-wrapper { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-start; overflow: hidden; }
        
        #managementModal .modal-content { max-width: 600px; }
        #managementModal .modal-title { color: #0369a1; }
        
        #itineraryItemModal .modal-content { max-width: 480px; }
        .itinerary-modal-item { 
            display: flex; justify-content: space-between; align-items: flex-start; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; background-color: #f8fafc; cursor: grab;
        }
        .itinerary-modal-item.dragging { opacity: 0.6; background-color: #dbeafe; }
        .drag-over { border-top: 2px dashed #60a5fa; }
        .itinerary-modal-item .item-details { flex-grow: 1; margin-right: 10px; }
        .itinerary-modal-item .item-description { word-break: break-word; font-weight: 500; color: #334155; }
        .itinerary-modal-item .item-description p:first-child { margin-top: 0; }
        .itinerary-modal-item .item-description p:last-child { margin-bottom: 0; }
        .itinerary-modal-item .item-time { font-size: 0.8rem; color: #475569; }
        .itinerary-modal-item .item-location { font-size: 0.8rem; color: #15803d; margin-top: 3px; }
        .itinerary-modal-item .item-tags { font-size: 0.75rem; color: #1d4ed8; margin-top: 3px; }
        .itinerary-modal-item .item-tags .tag { background-color: #e0e7ff; padding: 2px 5px; border-radius: 4px; margin-right: 4px; display: inline-block;}
        .itinerary-modal-item .item-actions { display: flex; flex-direction: column; gap: 5px; }
        .itinerary-modal-item .item-actions button { padding: 5px 10px; font-size: 0.8rem; border-radius: 6px; }
        .itinerary-modal-item .edit-btn { background-color: #3b82f6; color: white; }
        .itinerary-modal-item .edit-btn:hover { background-color: #2563eb; }
        .itinerary-modal-item .delete-btn { background-color: #ef4444; color: white; }
        .itinerary-modal-item .delete-btn:hover { background-color: #dc2626; }

        .form-input {
            width: 100%; padding: 0.625rem 0.75rem; 
            border: 1px solid #cbd5e1; 
            border-radius: 0.375rem; 
            font-size: 0.875rem; 
            color: #334155; 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
            outline: none;
        }
        .form-label {
            display: block; text-sm font-medium text-slate-700 mb-1;
        }
        .form-button {
            padding: 0.625rem 1.25rem; font-size: 0.875rem; font-weight: 500;
            border-radius: 0.375rem; transition: background-color 0.2s;
            color: white;
        }
        .form-button.primary { background-color: #2563eb; }
        .form-button.primary:hover { background-color: #1d4ed8; }
        .form-button.secondary { background-color: #64748b; }
        .form-button.secondary:hover { background-color: #475569; }
        .form-button.danger { background-color: #dc2626; }
        .form-button.danger:hover { background-color: #b91c1c; }
        .form-button.success { background-color: #16a34a; }
        .form-button.success:hover { background-color: #15803d; }
        .form-button.warning { background-color: #f59e0b; }
        .form-button.warning:hover { background-color: #d97706; }


        .time-input-group { display: flex; gap: 1rem; margin-top: 0.75rem; margin-bottom: 1rem; }
        .time-input-group > div { flex: 1; }

        #dayTooltip { position: absolute; display: none; background-color: white; border: 1px solid #e2e8f0; border-radius: 6px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); padding: 10px; z-index: 50; width: 280px; max-height: 220px; }
        #dayTooltipContent { max-height: 180px; overflow-y: auto; }
        .tooltip-item { font-size: 0.8rem; padding: 4px 0; border-bottom: 1px solid #f1f5f9; }
        .tooltip-item:last-child { border-bottom: none; }
        .tooltip-item .item-time { font-weight: 600; color: #1e293b; margin-right: 5px; }
        .tooltip-item .item-description { color: #475569; }
        .tooltip-item .item-description p:first-child { margin-top: 0; }
        .tooltip-item .item-description p:last-child { margin-bottom: 0; }
        .tooltip-item .item-location-tooltip { font-size: 0.75rem; color: #15803d; margin-top: 2px; }
        .tooltip-item .item-tags-tooltip { font-size: 0.7rem; color: #1d4ed8; margin-top: 2px; }
        .tooltip-item .item-tags-tooltip .tag { background-color: #e0e7ff; padding: 2px 5px; border-radius: 4px; margin-right: 4px; display: inline-block;}
        .tooltip-no-items { font-size: 0.8rem; color: #64748b; }
        
        #searchResultsModal .modal-content { max-width: 700px; }
        .search-result-item { padding: 0.75rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; }
        .search-result-item:hover { background-color: #f9fafb; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-date { font-weight: 600; color: #0369a1; margin-bottom: 0.25rem; }
        .search-result-description p { margin: 0.1rem 0;}

        #dayViewContainer {
            background-color: #ffffff; 
            padding: 24px; 
            border-radius: 12px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.08);
            margin-top: 1.5rem; 
        }
        #dayViewDateTitle {
            font-size: 1.5rem; 
            font-weight: 700; 
            color: #111827; 
            margin-bottom: 1.5rem; 
            padding-bottom: 0.75rem; 
            border-bottom: 1px solid #d1d5db; 
        }
        #dayViewEventsList {
            max-height: 65vh; 
            overflow-y: auto;
            padding-right: 0.5rem; 
        }
        .day-view-item {
            background-color: #f9fafb; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            padding: 1rem; 
            margin-bottom: 1rem; 
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }
        .day-view-item .item-details { flex-grow: 1; margin-right: 1rem; }
        .day-view-item .item-description { font-size: 0.95rem; color: #1f2937; }
        .day-view-item .item-description p { margin: 0.25rem 0; }
        .day-view-item .item-time { font-size: 0.85rem; color: #047857; font-weight: 500; margin-bottom: 0.25rem; }
        .day-view-item .item-location { font-size: 0.85rem; color: #4338ca; margin-top: 0.25rem; }
        .day-view-item .item-tags { font-size: 0.8rem; color: #0284c7; margin-top: 0.25rem; }
        .day-view-item .item-tags .tag { background-color: #e0f2fe; padding: 2px 6px; border-radius: 4px; margin-right: 4px; display: inline-block;}
        .day-view-item .item-actions { display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; }
        .day-view-item .item-actions button {
            padding: 0.375rem 0.75rem; font-size: 0.8rem; border-radius: 6px; 
            transition: background-color 0.2s;
        }
        .day-view-item .edit-btn { background-color: #3b82f6; color: white; } 
        .day-view-item .edit-btn:hover { background-color: #2563eb; }
        .day-view-item .delete-btn { background-color: #ef4444; color: white; } 
        .day-view-item .delete-btn:hover { background-color: #dc2626; }
        .day-view-no-items {
            text-align: center;
            padding: 2.5rem; 
            font-size: 1rem;
            color: #6b7280; 
        }
        .day-view-controls {
            margin-top: 1.5rem; 
            display: flex;
            justify-content: space-between; 
            align-items: center;
            gap: 0.75rem; 
        }
        .day-view-controls button { 
            padding: 0.5rem 1rem; 
            font-size: 0.875rem; 
            font-weight: 500;
            border-radius: 0.375rem; 
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
        }
        .day-view-controls .control-group-left {
            display: flex;
            gap: 0.75rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
        }
        .calendar-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem; 
        }
        .calendar-header-left .user-avatar {
            width: 36px; height: 36px;
            background-color: #93c5fd; 
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1e3a8a; 
        }
         .calendar-header-left .user-avatar i { font-size: 1rem; }

        #monthYearDisplayNav { 
            font-size: 1.5rem; 
            font-weight: 600; 
            color: #1f2937; 
            cursor: pointer; 
        }
         #monthYearDisplayNav:hover { color: #0056b3; }

        .calendar-header-right {
            display: flex;
            align-items: center;
            gap: 1rem; 
        }
        .calendar-header-right button {
            background-color: transparent;
            border: none;
            color: #4b5563; 
            font-size: 1.25rem; 
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
        }
        .calendar-header-right button:hover {
            background-color: #f3f4f6; 
            color: #1f2937; 
        }
        .calendar-grid-header {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 1px; 
            text-align: center;
            font-size: 0.75rem; 
            font-weight: 500; 
            color: #6b7280; 
            padding-bottom: 0.5rem; 
            border-bottom: 1px solid #e5e7eb; 
            margin-bottom: 0.5rem; 
        }
        .blank-day-cell {
            background-color: #f3f4f6; 
        }
        .current-month-day-cell {
            background-color: #ffffff; 
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="customAlert" class="custom-alert">
        <span id="customAlertMessage"></span>
    </div>

    <div id="dayTooltip">
        <div id="dayTooltipContent"></div>
    </div>

    <main class="container mx-auto p-4 md:p-6">
        <section id="calendarViewSection" class="bg-white p-4 sm:p-6 shadow-lg rounded-xl" aria-labelledby="calendar-section-title">
            <div class="calendar-header">
                <div class="calendar-header-left">
                    <div class="user-avatar" title="使用者設定 (未來功能)">
                        <i class="fas fa-user"></i>
                    </div>
                    <h2 id="monthYearDisplayNav" class="text-xl font-semibold text-gray-800" aria-live="polite" title="選擇月份 (未來功能)"></h2>
                </div>
                <div class="calendar-header-right">
                     <button id="searchButtonNav" type="button" title="搜尋行程">
                        <i class="fas fa-search"></i>
                    </button>
                    <button id="todayButtonNav" type="button" title="回到今天">
                        <i class="fas fa-calendar-day"></i>
                    </button>
                    <button id="openManagementModalButtonNav" type="button" title="設定">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            
            <div id="searchBarContainer" class="mb-4 flex gap-2 hidden"> 
                <input type="search" id="searchInput" placeholder="搜尋行程描述、標籤、地點..." class="form-input w-full">
                <button id="searchButton" type="button" class="form-button primary">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div id="monthControls" class="flex justify-between items-center mb-4">
                <button type="button" onclick="Calendar.changeMonth(-1)" class="bg-slate-200 hover:bg-slate-300 text-slate-700 py-2 px-3 rounded-md transition-colors text-sm" aria-label="上個月">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="monthYearDisplay" class="text-lg font-semibold text-sky-700" aria-live="polite"></h2> 
                <button type="button" onclick="Calendar.changeMonth(1)" class="bg-slate-200 hover:bg-slate-300 text-slate-700 py-2 px-3 rounded-md transition-colors text-sm" aria-label="下個月">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div id="calendarGridHeader" class="calendar-grid-header">
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-md overflow-hidden" aria-labelledby="monthYearDisplay">
            </div>

            <div id="itineraryControls" class="mt-6">
                <form onsubmit="event.preventDefault();"> <div>
                         <label for="scheduleNotes" class="form-label">行程表備註 (本月):</label>
                         <textarea id="scheduleNotes" rows="3" class="form-input" placeholder="例如：5月重要會議、團隊活動"></textarea>
                         <button id="saveNotesButton" type="button" class="mt-2 form-button success">儲存備註</button> </div>
                </form>
                <div class="mt-6 text-right">
                    <button id="exportItineraryButton" type="button" onclick="Exporter.exportItineraryToICS()" class="form-button success">
                        <i class="fas fa-file-export mr-2"></i>匯出行程表 (.ics)
                    </button>
                </div>
            </div>
        </section>

        <section id="dayViewContainer" class="hidden" aria-labelledby="dayViewDateTitle">
            <h2 id="dayViewDateTitle" class="text-2xl font-bold text-sky-800 mb-4"></h2>
            <div id="dayViewEventsList" class="space-y-3 mb-6">
            </div>
            <div class="day-view-controls">
                <div class="control-group-left">
                    <button id="addNewItemInDayViewButton" type="button" class="form-button success">
                        <i class="fas fa-plus mr-2"></i>新增本日行程
                    </button>
                    <button id="resetDayButton" type="button" class="form-button danger">
                        <i class="fas fa-trash-restore mr-2"></i>重置本日資料
                    </button>
                </div>
                <button id="backToCalendarViewButton" type="button" class="form-button secondary">
                    <i class="fas fa-calendar-alt mr-2"></i>返回月曆檢視
                </button>
            </div>
        </section>
    </main>

    <div id="managementModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="managementModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="managementModalTitle" class="modal-title">設定</h3>
                <button id="closeManagementModalButton" class="close-button" aria-label="關閉">&times;</button>
            </div>
            <div id="itineraryManagementContent" class="space-y-6">
                <div>
                    <h4 class="text-lg font-medium text-slate-800 mb-2">行程表設定</h4>
                    <form onsubmit="event.preventDefault(); ScheduleParser.triggerImportScheduleFromPastedText();" class="space-y-3">
                        <div>
                            <label for="fullSchedulePasteArea" class="form-label">貼上行程表文字 (簡易格式)</label>
                            <textarea id="fullSchedulePasteArea" rows="5" class="form-input" placeholder="每行一個行程項目，或包含日期 (如 5/15 會議)。支援 Markdown。"></textarea>
                        </div>
                        <button type="submit" class="w-full form-button warning">匯入貼上之文字</button>
                    </form>
                </div>
                <hr class="border-slate-200">
                <div class="space-y-3">
                   <label for="holidayFileImport" class="form-label">匯入假期檔案 (.ics)</label>
                   <input type="file" id="holidayFileImport" accept=".ics" class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200">
                   <button type="button" onclick="HolidayImporter.triggerHolidayImport()" class="w-full form-button primary">匯入假期</button>
               </div>
                <hr class="border-slate-200">
                <section aria-labelledby="itinerary-actions-title-modal" class="space-y-3">
                    <h4 id="itinerary-actions-title-modal" class="text-md font-medium text-slate-700">行程表儲存與清除</h4>
                    <div class="space-y-2">
                        <button id="saveItineraryButton" type="button" class="w-full form-button primary">儲存目前行程表</button>
                        <button id="clearItineraryButton" type="button" class="w-full form-button danger">清除本月行程表</button>
                    </div>
                </section>
                <p class="text-xs text-slate-500 mt-2 text-center">注意：行程表資料將儲存在您的瀏覽器中。</p>
            </div>
        </div>
    </div>

    <div id="itineraryItemModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="itineraryItemModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                 <button id="closeItineraryItemModalButton" class="close-button" aria-label="關閉">&times;</button>
                 <h3 id="itineraryItemModalTitle" class="modal-title text-center flex-grow">編輯行程項目</h3> 
                 <button class="text-slate-500 hover:text-slate-700 invisible"> 
                    <i class="fas fa-ellipsis-v"></i>
                 </button>
            </div>

            <div id="itineraryItemsList" data-date="" class="space-y-2 mb-4 max-h-48 overflow-y-auto border-b border-slate-200 pb-2">
            </div>

            <div class="space-y-4">
                <div>
                    <label for="newItineraryItemText" class="form-label">行程描述 (支援 Markdown):</label>
                    <textarea id="newItineraryItemText" rows="3" class="form-input" placeholder="輸入行程描述..."></textarea>
                </div>
                
                <div class="flex items-center justify-between">
                     <label for="timeSettingToggle" class="form-label mb-0">時間設定</label>
                     <button type="button" id="timeSettingToggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 bg-gray-200" role="switch" aria-checked="false">
                        <span class="sr-only">啟用時間設定</span>
                        <span id="timeSettingToggleKnob" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200 ease-in-out translate-x-1"></span>
                    </button>
                </div>

                <div id="timeInputsContainer" class="time-input-group hidden">
                    <div>
                        <label for="itineraryStartTime" class="form-label">開始時間:</label>
                        <input type="time" id="itineraryStartTime" class="form-input">
                    </div>
                    <div>
                        <label for="itineraryEndTime" class="form-label">結束時間:</label>
                        <input type="time" id="itineraryEndTime" class="form-input">
                    </div>
                </div>
                <div>
                    <label for="itineraryItemTags" class="form-label">標籤 (以逗號分隔):</label>
                    <input type="text" id="itineraryItemTags" class="form-input" placeholder="例如：工作,重要,會議">
                </div>
                <div>
                    <label for="itineraryItemLocation" class="form-label">地點:</label>
                    <input type="text" id="itineraryItemLocation" class="form-input" placeholder="例如：會議室 A, 公司">
                </div>
                <button id="addOrUpdateItineraryItemButton" type="button" class="w-full form-button primary mt-2">
                     <i class="fas fa-plus mr-2"></i>新增項目
                </button>
            </div>
        </div>
    </div>

    <div id="searchResultsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="searchResultsModalTitle">
         <div class="modal-content">
            <div class="modal-header">
                <h3 id="searchResultsModalTitle" class="modal-title">搜尋結果</h3>
                <button id="closeSearchResultsModalButton" class="close-button" aria-label="關閉">&times;</button>
            </div>
            <div id="searchResultsList" class="max-h-[60vh] overflow-y-auto mt-4">
            </div>
        </div>
    </div>

    <script>
    // AppState
    let AppState = {
        currentYear: new Date().getFullYear(), currentMonth: new Date().getMonth(),
        shifts: {}, notes: '', selectedDateForAssignment: null, holidays: {},
        editingItemId: null, draggedItemId: null, tooltipTimeout: null,
        currentView: 'calendar', 
        selectedDayForDayView: null,
        isTimeSettingEnabled: false 
    };

    // UIElements
    const UIElements = {
        mainTitle: null, monthYearDisplay: null, calendarGrid: null, calendarGridHeader: null,
        monthYearDisplayNav: null, searchButtonNav: null, openManagementModalButtonNav: null, todayButtonNav: null,
        fullSchedulePasteArea: null, 
        itineraryItemModal: null, itineraryItemsList: null, newItineraryItemText: null, 
        itineraryStartTime: null, itineraryEndTime: null, itineraryItemTags: null, itineraryItemLocation: null,
        addOrUpdateItineraryItemButton: null, closeItineraryItemModalButton: null,
        timeSettingToggle: null, timeSettingToggleKnob: null, timeInputsContainer: null,
        scheduleNotesTextarea: null, customAlertBox: null, customAlertMessageBox: null, saveNotesButton: null,
        itineraryControls: null, exportItineraryButton: null,
        saveItineraryButton: null, clearItineraryButton: null,
        managementModal: null, openManagementModalButton: null, closeManagementModalButton: null,
        itineraryManagementContent: null,
        dayTooltip: null, dayTooltipContent: null,
        searchInput: null, searchButton: null, searchBarContainer: null, monthControls: null,
        searchResultsModal: null, searchResultsList: null, closeSearchResultsModalButton: null,
        calendarViewSection: null, dayViewContainer: null, dayViewDateTitle: null, dayViewEventsList: null,
        addNewItemInDayViewButton: null, backToCalendarViewButton: null, resetDayButton: null
    };

    // Utils
    const Utils = {
        showCustomAlert: (message, type = 'error', duration = 3500) => {
            if (!UIElements.customAlertBox || !UIElements.customAlertMessageBox) return;
            UIElements.customAlertMessageBox.textContent = message;
            UIElements.customAlertBox.className = 'custom-alert';
            UIElements.customAlertBox.classList.add(type);
            UIElements.customAlertBox.style.display = 'block';
            if (duration > 0) {
                setTimeout(() => { if(UIElements.customAlertBox) UIElements.customAlertBox.style.display = 'none'; }, duration);
            }
        },
        hideCustomAlert: () => {
            if (UIElements.customAlertBox) UIElements.customAlertBox.style.display = 'none';
        },
        getLocalStorageKey: (dataType, year = AppState.currentYear, month = AppState.currentMonth) => {
            const version = "v3.32_weekend_fix"; // Updated version
            if (dataType === 'holidays_all') {
               return `personalItinerary_${version}_holidays_all`;
            }
            return `personalItinerary_${version}_${dataType}_${year}_${String(month + 1).padStart(2, '0')}`;
        },
        generateUUID: () => {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, 
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        },
        getTodayDateString: () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    };

    // DataStorage
    const DataStorage = {
        loadDataForCurrentMonth: () => {
            try {
                const shiftsData = localStorage.getItem(Utils.getLocalStorageKey('shifts'));
                const parsedShifts = shiftsData ? JSON.parse(shiftsData) : {};
                AppState.shifts = {}; 
                for (const dateKey in parsedShifts) {
                    if (Array.isArray(parsedShifts[dateKey])) {
                        AppState.shifts[dateKey] = parsedShifts[dateKey].map(item => ({
                            id: item.id || Utils.generateUUID(),
                            description: item.description || "",
                            startTime: item.startTime || "", 
                            endTime: item.endTime || "",
                            tags: Array.isArray(item.tags) ? item.tags : [],
                            location: item.location || "" 
                        }));
                    } else { 
                        AppState.shifts[dateKey] = [{ 
                            id: Utils.generateUUID(), 
                            description: String(parsedShifts[dateKey]),
                            startTime: "", endTime: "", tags: [], location: ""
                        }];
                    }
                }
                const notesData = localStorage.getItem(Utils.getLocalStorageKey('notes'));
                AppState.notes = notesData ? notesData : '';
                if (UIElements.scheduleNotesTextarea) UIElements.scheduleNotesTextarea.value = AppState.notes;
                const holidaysData = localStorage.getItem(Utils.getLocalStorageKey('holidays_all'));
                AppState.holidays = holidaysData ? JSON.parse(holidaysData) : {};
            } catch (e) { console.error("Error loading data:", e); Utils.showCustomAlert("讀取資料時發生錯誤。", "error"); }
        },
        saveDataForCurrentMonth: () => { 
            try {
                localStorage.setItem(Utils.getLocalStorageKey('shifts'), JSON.stringify(AppState.shifts));
                localStorage.setItem(Utils.getLocalStorageKey('notes'), AppState.notes);
                localStorage.setItem(Utils.getLocalStorageKey('holidays_all'), JSON.stringify(AppState.holidays));
            } catch (e) { console.error("Error saving data:", e); Utils.showCustomAlert("儲存資料時發生錯誤。", "error"); }
        },
        clearCurrentMonthItinerary: () => { 
            const currentMonthPrefix = `${AppState.currentYear}-${String(AppState.currentMonth + 1).padStart(2, '0')}`;
            let itemsCleared = false;
            for (const dateKey in AppState.shifts) {
                if (dateKey.startsWith(currentMonthPrefix)) {
                    if (AppState.shifts[dateKey] && AppState.shifts[dateKey].length > 0) itemsCleared = true;
                    delete AppState.shifts[dateKey];
                }
            }
            AppState.notes = "";
            if (UIElements.scheduleNotesTextarea) UIElements.scheduleNotesTextarea.value = "";
            DataStorage.saveDataForCurrentMonth();
            Calendar.render(); 
            if (AppState.currentView === 'day' && AppState.selectedDayForDayView && AppState.selectedDayForDayView.startsWith(currentMonthPrefix)) {
                DayView.renderDayViewItems(AppState.selectedDayForDayView); 
            }
            Utils.showCustomAlert(itemsCleared || AppState.notes === "" ? `已清除 ${AppState.currentYear}年 ${AppState.currentMonth + 1}月 的行程表資料與備註。` : `${AppState.currentYear}年 ${AppState.currentMonth + 1}月 的行程表無資料可清除。`, itemsCleared || AppState.notes === "" ? "success" : "info");
        }
    };
    
    // HolidayImporter
    const HolidayImporter = { 
        parseICS: (icsContent) => {
            const lines = icsContent.split(/\r\n|\n|\r/);
            let inEvent = false;
            let currentEvent = { DTSTART_val: null, DTEND_val: null, SUMMARY_val: null };
            let newHolidays = {};
            const parseDateFromICSLine = (line) => {
                if (!line) return null;
                const dateStrPart = line.substring(line.indexOf(':') + 1);
                const actualDateStr = dateStrPart.includes('VALUE=DATE:') ? dateStrPart.substring('VALUE=DATE:'.length) : dateStrPart;
                if (actualDateStr.length < 8) return null; 
                const year = parseInt(actualDateStr.substring(0, 4));
                const month = parseInt(actualDateStr.substring(4, 6)) - 1; 
                const day = parseInt(actualDateStr.substring(6, 8));
                if (isNaN(year) || isNaN(month) || isNaN(day) || month < 0 || month > 11 || day < 1 || day > 31) {
                     console.warn("Invalid date parsed from ICS:", actualDateStr); return null;
                }
                return new Date(Date.UTC(year, month, day)); 
            };
            const formatDateToKey = (dateObj) => {
                if (!dateObj) return null;
                const year = dateObj.getUTCFullYear();
                const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getUTCDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            for (const line of lines) {
                if (line.toUpperCase().startsWith('BEGIN:VEVENT')) {
                    inEvent = true;
                    currentEvent = { DTSTART_val: null, DTEND_val: null, SUMMARY_val: null };
                } else if (line.toUpperCase().startsWith('END:VEVENT')) {
                    if (inEvent && currentEvent.DTSTART_val && currentEvent.SUMMARY_val) {
                        let startDate = currentEvent.DTSTART_val;
                        let endDate = currentEvent.DTEND_val;
                        if (!endDate || endDate.getTime() <= startDate.getTime()) {
                            const formattedDate = formatDateToKey(startDate);
                            if (formattedDate) newHolidays[formattedDate] = currentEvent.SUMMARY_val;
                        } else {
                            let currentDate = new Date(startDate.getTime());
                            while (currentDate.getTime() < endDate.getTime()) { 
                                const formattedDate = formatDateToKey(currentDate);
                                if (formattedDate) newHolidays[formattedDate] = currentEvent.SUMMARY_val;
                                currentDate.setUTCDate(currentDate.getUTCDate() + 1); 
                            }
                        }
                    }
                    inEvent = false;
                } else if (inEvent) {
                    if (line.toUpperCase().startsWith('DTSTART')) {
                        currentEvent.DTSTART_val = parseDateFromICSLine(line);
                    } else if (line.toUpperCase().startsWith('DTEND')) {
                        currentEvent.DTEND_val = parseDateFromICSLine(line);
                    } else if (line.toUpperCase().startsWith('SUMMARY')) {
                        currentEvent.SUMMARY_val = line.substring(line.indexOf(':') + 1).trim();
                    }
                }
            }
            return newHolidays;
        },
        triggerHolidayImport: () => {
            const fileInput = document.getElementById('holidayFileImport');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                Utils.showCustomAlert("請先選擇一個 .ics 假期檔案。", "info");
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedHolidays = HolidayImporter.parseICS(e.target.result);
                    if (Object.keys(importedHolidays).length > 0) {
                        AppState.holidays = { ...AppState.holidays, ...importedHolidays }; 
                        DataStorage.saveDataForCurrentMonth(); 
                        Calendar.render();
                        if (AppState.currentView === 'day' && AppState.selectedDayForDayView) {
                            DayView.renderDayViewItems(AppState.selectedDayForDayView);
                        }
                        Utils.showCustomAlert(`成功匯入 ${Object.keys(importedHolidays).length} 個假期。`, "success");
                        fileInput.value = ""; 
                    } else {
                        Utils.showCustomAlert("未在檔案中找到有效的假期事件。", "info");
                        fileInput.value = "";
                    }
                } catch (err) {
                    console.error("Error parsing holiday file:", err);
                    Utils.showCustomAlert("解析假期檔案時發生錯誤。", "error");
                    fileInput.value = "";
                }
            };
            reader.onerror = () => {
                Utils.showCustomAlert("讀取假期檔案時發生錯誤。", "error");
                fileInput.value = "";
            };
            reader.readAsText(file);
        }
    };

    // Calendar
    const Calendar = { 
        render: () => {
            if (!UIElements.monthYearDisplayNav || !UIElements.monthYearDisplay || !UIElements.calendarGrid || !UIElements.calendarGridHeader) return;
            
            UIElements.calendarGrid.innerHTML = ''; 
            UIElements.calendarGridHeader.innerHTML = '';

            const currentDisplayDate = new Date(AppState.currentYear, AppState.currentMonth, 1);
            const monthName = currentDisplayDate.toLocaleString('zh-Hant-TW', { month: 'long' });
            const year = AppState.currentYear;
            
            UIElements.monthYearDisplayNav.textContent = `${year}, ${monthName}`;
            UIElements.monthYearDisplay.textContent = `${year}年 ${AppState.currentMonth + 1}月`;


            const firstDayOfMonth = new Date(AppState.currentYear, AppState.currentMonth, 1);
            const lastDayOfMonth = new Date(AppState.currentYear, AppState.currentMonth + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const dayOfWeek = firstDayOfMonth.getDay(); 
            
            const dayNames = ['日', '一', '二', '三', '四', '五', '六'];
            dayNames.forEach(name => {
                const dayHeaderCell = document.createElement('div');
                dayHeaderCell.textContent = name;
                if (name === '日' || name === '六') { // Add red color to weekend headers
                    dayHeaderCell.classList.add('text-red-600');
                }
                UIElements.calendarGridHeader.appendChild(dayHeaderCell);
            });

            for (let i = 0; i < dayOfWeek; i++) { 
                const blankCell = document.createElement('div');
                blankCell.className = 'calendar-day blank-day-cell p-1.5';
                UIElements.calendarGrid.appendChild(blankCell);
            }
            
            const todayDateString = Utils.getTodayDateString();

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                const dateStr = `${AppState.currentYear}-${String(AppState.currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                dayCell.className = 'calendar-day current-month-day-cell p-1.5';
                if (dateStr === todayDateString) {
                    dayCell.classList.add('today');
                }
                dayCell.dataset.date = dateStr;

                const dayNumberContainer = document.createElement('div');
                dayNumberContainer.className = 'flex justify-center mb-1';
                const dayNumber = document.createElement('span');
                dayNumber.className = 'day-number-display';
                dayNumber.textContent = day;

                const currentDate = new Date(AppState.currentYear, AppState.currentMonth, day);
                const currentDayOfWeek = currentDate.getDay();
                const isWeekend = currentDayOfWeek === 0 || currentDayOfWeek === 6;
                const holidayName = AppState.holidays[dateStr];

                if (isWeekend || holidayName) {
                    // Apply red text unless it's today's blue circle (which has !important white text)
                    if (!(dateStr === todayDateString)) { // Avoid overriding today's white text
                       dayNumber.classList.add('text-red-600', 'font-semibold');
                    } else {
                        // For today, if it's a weekend/holiday, the background is blue, text is white.
                        // If you want today's number to ALSO be red if it's a weekend/holiday,
                        // you'd need more specific CSS or remove !important from .today .day-number-display color.
                        // For now, today's blue circle with white text takes precedence.
                    }
                }


                dayNumberContainer.appendChild(dayNumber);
                dayCell.appendChild(dayNumberContainer);
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'day-content-wrapper space-y-1';

                const itineraryItemsForDay = AppState.shifts[dateStr] || [];
                
                if (itineraryItemsForDay.length > 0) {
                    itineraryItemsForDay.slice(0, 2).forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'itinerary-item-display';
                        let displayText = item.startTime ? `${item.startTime} ` : "";
                        try {
                            displayText += (typeof marked !== 'undefined' && marked.parse) ? marked.parse(item.description || "").trim().replace(/<p>|<\/p>/g, "") : (item.description || "").trim();
                        } catch (e) { displayText += item.description || ""; }
                        itemDiv.innerHTML = displayText;
                        itemDiv.title = item.description; 
                        contentWrapper.appendChild(itemDiv);
                    });

                    if (itineraryItemsForDay.length > 2) {
                        const itemCountSpan = document.createElement('span');
                        itemCountSpan.className = 'itinerary-item-count text-xs';
                        itemCountSpan.textContent = `+${itineraryItemsForDay.length - 2} 更多`;
                        contentWrapper.appendChild(itemCountSpan);
                    }
                }
                
                if (holidayName) {
                    const holidaySpan = document.createElement('div');
                    holidaySpan.textContent = holidayName; 
                    holidaySpan.className = 'holiday-info text-orange-600 font-medium text-xs mt-auto text-center truncate px-1';
                    contentWrapper.appendChild(holidaySpan); 
                }

                dayCell.appendChild(contentWrapper);
                
                dayCell.addEventListener('click', (event) => {
                    DayView.openDayView(dateStr);
                });
                dayCell.addEventListener('mouseenter', (event) => UI.showTooltip(event, dateStr));
                dayCell.addEventListener('mouseleave', UI.hideTooltip);
                UIElements.calendarGrid.appendChild(dayCell);
            }

            const totalCells = dayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) { 
                const blankCell = document.createElement('div');
                blankCell.className = 'calendar-day blank-day-cell p-1.5';
                UIElements.calendarGrid.appendChild(blankCell);
            }
        },
        changeMonth: (offset) => { 
            if (UIElements.scheduleNotesTextarea) {
                AppState.notes = UIElements.scheduleNotesTextarea.value; 
            }
            DataStorage.saveDataForCurrentMonth(); 

            AppState.currentMonth += offset;
            if (AppState.currentMonth < 0) {
                AppState.currentMonth = 11;
                AppState.currentYear--;
            } else if (AppState.currentMonth > 11) {
                AppState.currentMonth = 0;
                AppState.currentYear++;
            }
            DataStorage.loadDataForCurrentMonth(); 
            Calendar.render();
        },
        goToToday: () => {
            const today = new Date();
            AppState.currentYear = today.getFullYear();
            AppState.currentMonth = today.getMonth();
            DataStorage.loadDataForCurrentMonth();
            Calendar.render();
            Utils.showCustomAlert("已跳至今日所在月份。", "info", 2000);
        }
    };

    // ScheduleParser
    const ScheduleParser = { 
        parseTextToIntermediateData: (text, inputYear, inputMonth_1_indexed) => {
            const lines = text.split('\n').map(line => line.trim());
            let yearToUse = inputYear;
            let monthToUse_0_indexed = inputMonth_1_indexed !== null ? inputMonth_1_indexed - 1 : null; 
            let tempShifts = {};
            let tempNotesFromParser = "";
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const yearMonthMatch = line.match(/(\d+)\s*年\s*(\d+)\s*月/);
                if (yearMonthMatch) {
                    let parsedYearFromText = parseInt(yearMonthMatch[1]);
                    if (parsedYearFromText < 200 && parsedYearFromText > 90) parsedYearFromText += 1911; 
                    yearToUse = parsedYearFromText;
                    monthToUse_0_indexed = parseInt(yearMonthMatch[2]) - 1; 
                    lines.splice(i, 1); i--; 
                    break; 
                }
            }
            if (yearToUse === null || yearToUse === undefined || isNaN(yearToUse)) yearToUse = AppState.currentYear;
            if (monthToUse_0_indexed === null || monthToUse_0_indexed === undefined || isNaN(monthToUse_0_indexed)) monthToUse_0_indexed = AppState.currentMonth;
            lines.forEach(line => {
                if (line.trim() === "") return;
                const dateMatch = line.match(/^(\d{1,2}(?:\/\d{1,2})?)\s+(.+)/);
                if (dateMatch) {
                    const datePart = dateMatch[1];
                    const description = dateMatch[2].trim();
                    let day, month;
                    if (datePart.includes('/')) {
                        [month, day] = datePart.split('/').map(Number);
                        month -= 1; 
                    } else {
                        day = parseInt(datePart);
                        month = monthToUse_0_indexed; 
                    }
                    if (!isNaN(day) && day >= 1 && day <= 31 && !isNaN(month) && month >=0 && month <=11) {
                        const dateStr = `${yearToUse}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        if (!tempShifts[dateStr]) tempShifts[dateStr] = [];
                        tempShifts[dateStr].push({ id: Utils.generateUUID(), description: description, startTime: "", endTime: "", tags: [], location: "" });
                    } else { 
                        if (!tempNotesFromParser) tempNotesFromParser = line; else tempNotesFromParser += "\n" + line;
                    }
                } else { 
                    if (!tempNotesFromParser) tempNotesFromParser = line; else tempNotesFromParser += "\n" + line;
                }
            });
            const success = Object.keys(tempShifts).length > 0 || tempNotesFromParser.length > 0;
            return { success, parsedYear: yearToUse, parsedMonth: monthToUse_0_indexed, parsedShifts: tempShifts, parsedNotes: tempNotesFromParser };
        },
        applyParsedDataToAppState: (year, month_0_indexed, shiftsToApply, notesToApply) => {
            AppState.currentYear = year;
            AppState.currentMonth = month_0_indexed;
            const targetMonthPrefix = `${year}-${String(month_0_indexed + 1).padStart(2, '0')}`;
            for (const dateKey in AppState.shifts) {
                if (dateKey.startsWith(targetMonthPrefix)) {
                    delete AppState.shifts[dateKey];
                }
            }
            for(const dateKey in shiftsToApply) {
                if (dateKey.startsWith(targetMonthPrefix)) { 
                    if (!AppState.shifts[dateKey]) AppState.shifts[dateKey] = [];
                    AppState.shifts[dateKey].push(...shiftsToApply[dateKey]);
                }
            }
            if (notesToApply && notesToApply.trim() !== "") {
                if (AppState.notes) AppState.notes += "\n" + notesToApply;
                else AppState.notes = notesToApply;
            }
            if (UIElements.scheduleNotesTextarea) UIElements.scheduleNotesTextarea.value = AppState.notes;
            DataStorage.saveDataForCurrentMonth(); 
            Calendar.render(); 
            Utils.showCustomAlert(`行程表已成功匯入/更新 ${year}年${month_0_indexed + 1}月 的資料！`, "success");
        },
        triggerImportScheduleFromPastedText: () => {
            if (!UIElements.fullSchedulePasteArea) return;
            const text = UIElements.fullSchedulePasteArea.value;
            if (!text.trim()) {
                Utils.showCustomAlert("請先在文字區域貼上行程表的內容。", "info");
                return;
            }
            const intermediateData = ScheduleParser.parseTextToIntermediateData(text, AppState.currentYear, AppState.currentMonth + 1);
            if (intermediateData.success) {
                ScheduleParser.applyParsedDataToAppState(
                    intermediateData.parsedYear, intermediateData.parsedMonth,
                    intermediateData.parsedShifts, intermediateData.parsedNotes
                );
                 UIElements.fullSchedulePasteArea.value = ""; 
            } else {
                 Utils.showCustomAlert("未能在貼上的文字中找到任何有效的行程表資料。", "error");
            }
        }
    };

    // UI
    const UI = {
        cacheDOMElements: () => {
            UIElements.mainTitle = document.getElementById('mainTitle'); 
            UIElements.monthYearDisplay = document.getElementById('monthYearDisplay');
            UIElements.calendarGrid = document.getElementById('calendarGrid');
            UIElements.calendarGridHeader = document.getElementById('calendarGridHeader');
            UIElements.monthYearDisplayNav = document.getElementById('monthYearDisplayNav');
            UIElements.searchButtonNav = document.getElementById('searchButtonNav');
            UIElements.openManagementModalButtonNav = document.getElementById('openManagementModalButtonNav');
            UIElements.todayButtonNav = document.getElementById('todayButtonNav');

            UIElements.fullSchedulePasteArea = document.getElementById('fullSchedulePasteArea');
            
            UIElements.itineraryItemModal = document.getElementById('itineraryItemModal');
            UIElements.itineraryItemsList = document.getElementById('itineraryItemsList');
            UIElements.newItineraryItemText = document.getElementById('newItineraryItemText');
            UIElements.itineraryStartTime = document.getElementById('itineraryStartTime');
            UIElements.itineraryEndTime = document.getElementById('itineraryEndTime');
            UIElements.itineraryItemTags = document.getElementById('itineraryItemTags');
            UIElements.itineraryItemLocation = document.getElementById('itineraryItemLocation');
            UIElements.addOrUpdateItineraryItemButton = document.getElementById('addOrUpdateItineraryItemButton');
            UIElements.closeItineraryItemModalButton = document.getElementById('closeItineraryItemModalButton');
            UIElements.timeSettingToggle = document.getElementById('timeSettingToggle');
            UIElements.timeSettingToggleKnob = document.getElementById('timeSettingToggleKnob');
            UIElements.timeInputsContainer = document.getElementById('timeInputsContainer');
            
            UIElements.scheduleNotesTextarea = document.getElementById('scheduleNotes');
            UIElements.customAlertBox = document.getElementById('customAlert');
            UIElements.customAlertMessageBox = document.getElementById('customAlertMessage');
            UIElements.saveNotesButton = document.getElementById('saveNotesButton');
            
            UIElements.itineraryControls = document.getElementById('itineraryControls');
            UIElements.exportItineraryButton = document.getElementById('exportItineraryButton');
            
            UIElements.saveItineraryButton = document.getElementById('saveItineraryButton');
            UIElements.clearItineraryButton = document.getElementById('clearItineraryButton');
            
            UIElements.managementModal = document.getElementById('managementModal');
            UIElements.closeManagementModalButton = document.getElementById('closeManagementModalButton');
            UIElements.itineraryManagementContent = document.getElementById('itineraryManagementContent');
            
            UIElements.dayTooltip = document.getElementById('dayTooltip');
            UIElements.dayTooltipContent = document.getElementById('dayTooltipContent');

            UIElements.searchInput = document.getElementById('searchInput'); 
            UIElements.searchButton = document.getElementById('searchButton'); 
            UIElements.searchBarContainer = document.getElementById('searchBarContainer');
            UIElements.monthControls = document.getElementById('monthControls');

            UIElements.searchResultsModal = document.getElementById('searchResultsModal');
            UIElements.searchResultsList = document.getElementById('searchResultsList');
            UIElements.closeSearchResultsModalButton = document.getElementById('closeSearchResultsModalButton');

            UIElements.calendarViewSection = document.getElementById('calendarViewSection');
            UIElements.dayViewContainer = document.getElementById('dayViewContainer');
            UIElements.dayViewDateTitle = document.getElementById('dayViewDateTitle');
            UIElements.dayViewEventsList = document.getElementById('dayViewEventsList');
            UIElements.addNewItemInDayViewButton = document.getElementById('addNewItemInDayViewButton');
            UIElements.backToCalendarViewButton = document.getElementById('backToCalendarViewButton');
            UIElements.resetDayButton = document.getElementById('resetDayButton');
        },
        setActiveView: (view) => { 
            AppState.currentView = view;
            if (view === 'calendar') {
                if (UIElements.calendarViewSection) UIElements.calendarViewSection.classList.remove('hidden');
                if (UIElements.dayViewContainer) UIElements.dayViewContainer.classList.add('hidden');
                Calendar.render(); 
            } else if (view === 'day') {
                if (UIElements.calendarViewSection) UIElements.calendarViewSection.classList.add('hidden');
                if (UIElements.dayViewContainer) UIElements.dayViewContainer.classList.remove('hidden');
            }
        },
        toggleTimeSetting: (forceState) => {
            AppState.isTimeSettingEnabled = typeof forceState === 'boolean' ? forceState : !AppState.isTimeSettingEnabled;
            if (UIElements.timeSettingToggle && UIElements.timeInputsContainer && UIElements.timeSettingToggleKnob) {
                if (AppState.isTimeSettingEnabled) {
                    UIElements.timeSettingToggle.classList.remove('bg-gray-200');
                    UIElements.timeSettingToggle.classList.add('bg-sky-600');
                    UIElements.timeSettingToggleKnob.classList.remove('translate-x-1');
                    UIElements.timeSettingToggleKnob.classList.add('translate-x-6'); 
                    UIElements.timeInputsContainer.classList.remove('hidden');
                    UIElements.timeSettingToggle.setAttribute('aria-checked', 'true');
                } else {
                    UIElements.timeSettingToggle.classList.add('bg-gray-200');
                    UIElements.timeSettingToggle.classList.remove('bg-sky-600');
                    UIElements.timeSettingToggleKnob.classList.add('translate-x-1');
                    UIElements.timeSettingToggleKnob.classList.remove('translate-x-6');
                    UIElements.timeInputsContainer.classList.add('hidden');
                    UIElements.timeSettingToggle.setAttribute('aria-checked', 'false');
                }
            }
        },
        openItineraryItemModal: (dateStr, itemIdToEdit = null) => { 
            if (!UIElements.itineraryItemModal || !UIElements.itineraryItemsList || !UIElements.newItineraryItemText || !UIElements.addOrUpdateItineraryItemButton || !UIElements.itineraryStartTime || !UIElements.itineraryEndTime || !UIElements.itineraryItemTags || !UIElements.itineraryItemLocation) return;
            
            AppState.selectedDateForAssignment = dateStr; 
            UIElements.itineraryItemsList.dataset.date = dateStr; 
            
            const modalTitleEl = UIElements.itineraryItemModal.querySelector('#itineraryItemModalTitle');
            const [year, month, day] = dateStr.split('-');
            const displayDate = new Date(year, parseInt(month)-1, day);
            const formattedDate = displayDate.toLocaleDateString('zh-Hant-TW', { month: 'short', day: 'numeric', weekday: 'short'});

            UIElements.newItineraryItemText.value = '';
            UIElements.itineraryStartTime.value = '';
            UIElements.itineraryEndTime.value = '';
            UIElements.itineraryItemTags.value = ''; 
            UIElements.itineraryItemLocation.value = '';
            UIElements.addOrUpdateItineraryItemButton.innerHTML = '<i class="fas fa-plus mr-2"></i>新增項目';
            if (modalTitleEl) modalTitleEl.textContent = `新增於 ${formattedDate}`;
            AppState.editingItemId = null; 
            let hasTime = false;

            if (itemIdToEdit) {
                const itemsOnDate = AppState.shifts[dateStr] || [];
                const item = itemsOnDate.find(i => i.id === itemIdToEdit);
                if (item) {
                    UI.prepareEditItineraryItem(dateStr, item); 
                    if (modalTitleEl) modalTitleEl.textContent = `編輯於 ${formattedDate}`;
                    hasTime = !!item.startTime || !!item.endTime;
                }
            }
            
            UI.toggleTimeSetting(hasTime); 
            UI.renderItineraryItemsInModal(dateStr); 
            
            UIElements.itineraryItemModal.style.display = 'flex';
            UIElements.newItineraryItemText.focus();
        },
        closeItineraryItemModal: () => { 
            if (UIElements.itineraryItemModal) UIElements.itineraryItemModal.style.display = 'none';
            if (AppState.currentView === 'day' && AppState.selectedDayForDayView) {
                DayView.renderDayViewItems(AppState.selectedDayForDayView);
            }
        },
        renderItineraryItemsInModal: (dateStr) => { 
            if (!UIElements.itineraryItemsList) return;
            UIElements.itineraryItemsList.innerHTML = ''; 
            const items = [...(AppState.shifts[dateStr] || [])].sort((a,b) => (a.startTime || "23:59").localeCompare(b.startTime || "23:59"));

            if (items.length <= 1 && AppState.editingItemId) { 
                UIElements.itineraryItemsList.classList.add('hidden');
                return;
            }
            UIElements.itineraryItemsList.classList.remove('hidden');

            if (items.length === 0) {
                UIElements.itineraryItemsList.innerHTML = '<p class="text-sm text-slate-500 p-2">此日期尚無其他行程項目。</p>';
                return;
            }

            items.forEach(item => {
                if (item.id === AppState.editingItemId) return; 

                const itemDiv = document.createElement('div');
                itemDiv.className = 'itinerary-modal-item'; 
                itemDiv.setAttribute('draggable', true); 
                itemDiv.dataset.itemId = item.id; 
                
                const itemDetailsDiv = document.createElement('div');
                itemDetailsDiv.className = 'item-details';

                const itemDescriptionP = document.createElement('p');
                itemDescriptionP.className = 'item-description text-sm';
                try { 
                    itemDescriptionP.innerHTML = (typeof marked !== 'undefined' && marked.parse) ? marked.parse(item.description || "").trim().replace(/<p>|<\/p>/g, "") : (item.description || "").trim(); 
                } catch(e) { itemDescriptionP.textContent = (item.description || "").trim(); }
                itemDetailsDiv.appendChild(itemDescriptionP);

                if (item.startTime) {
                    const itemTimeP = document.createElement('p');
                    itemTimeP.className = 'item-time text-xs';
                    itemTimeP.textContent = item.startTime + (item.endTime ? ` - ${item.endTime}` : '');
                    itemDetailsDiv.appendChild(itemTimeP);
                }
                itemDiv.appendChild(itemDetailsDiv);

                const buttonGroup = document.createElement('div');
                buttonGroup.className = 'item-actions';

                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                editBtn.className = 'edit-btn rounded-md p-1.5 text-xs';
                editBtn.title = '編輯此項目';
                editBtn.onclick = (e) => { e.stopPropagation(); UI.openItineraryItemModal(dateStr, item.id); };
                buttonGroup.appendChild(editBtn);
                itemDiv.appendChild(buttonGroup);
                UIElements.itineraryItemsList.appendChild(itemDiv);
            });
             if (UIElements.itineraryItemsList.children.length === 0) {
                UIElements.itineraryItemsList.classList.add('hidden');
            }
        },
        prepareEditItineraryItem: (dateStr, itemToEdit) => { 
            if (!UIElements.newItineraryItemText || !UIElements.addOrUpdateItineraryItemButton || !UIElements.itineraryStartTime || !UIElements.itineraryEndTime || !UIElements.itineraryItemTags || !UIElements.itineraryItemLocation) return;
            
            AppState.editingItemId = itemToEdit.id; 
            AppState.selectedDateForAssignment = dateStr; 
            
            UIElements.newItineraryItemText.value = itemToEdit.description;
            UIElements.itineraryStartTime.value = itemToEdit.startTime || "";
            UIElements.itineraryEndTime.value = itemToEdit.endTime || "";
            UIElements.itineraryItemTags.value = itemToEdit.tags ? itemToEdit.tags.join(', ') : "";
            UIElements.itineraryItemLocation.value = itemToEdit.location || "";
            
            UIElements.addOrUpdateItineraryItemButton.innerHTML = '<i class="fas fa-save mr-2"></i>更新項目'; 
            UI.toggleTimeSetting(!!(itemToEdit.startTime || itemToEdit.endTime)); 
            UIElements.newItineraryItemText.focus(); 
        },
        addOrUpdateItineraryItem: () => { 
            if (!AppState.selectedDateForAssignment || !UIElements.newItineraryItemText) return;
            
            const description = UIElements.newItineraryItemText.value.trim();
            let startTime = UIElements.itineraryStartTime.value;
            let endTime = UIElements.itineraryEndTime.value;
            const tagsString = UIElements.itineraryItemTags.value.trim();
            const tags = tagsString ? tagsString.split(/[,，\s]+/).map(tag => tag.trim()).filter(tag => tag) : [];
            const location = UIElements.itineraryItemLocation.value.trim();

            if (!description) { Utils.showCustomAlert("行程描述不可為空。", "info"); return; }

            if (!AppState.isTimeSettingEnabled) { 
                startTime = "";
                endTime = "";
            } else {
                 if (endTime && !startTime) { Utils.showCustomAlert("若設定結束時間，請同時設定開始時間。", "info"); return; }
                 if (startTime && endTime && endTime < startTime) { Utils.showCustomAlert("結束時間不可早於開始時間。", "info"); return; }
            }

            const dateStr = AppState.selectedDateForAssignment;
            if (!AppState.shifts[dateStr]) AppState.shifts[dateStr] = [];

            if (AppState.editingItemId) { 
                const itemIndex = AppState.shifts[dateStr].findIndex(item => item.id === AppState.editingItemId);
                if (itemIndex > -1) {
                    AppState.shifts[dateStr][itemIndex].description = description;
                    AppState.shifts[dateStr][itemIndex].startTime = startTime;
                    AppState.shifts[dateStr][itemIndex].endTime = endTime;
                    AppState.shifts[dateStr][itemIndex].tags = tags;
                    AppState.shifts[dateStr][itemIndex].location = location;
                    Utils.showCustomAlert("行程項目已更新。", "success", 1500);
                }
            } else { 
                const newItem = { id: Utils.generateUUID(), description: description, startTime: startTime, endTime: endTime, tags: tags, location: location };
                AppState.shifts[dateStr].push(newItem);
                Utils.showCustomAlert("行程項目已新增。", "success", 1500);
            }

            DataStorage.saveDataForCurrentMonth();
            
            if (AppState.currentView === 'day' && AppState.selectedDayForDayView === dateStr) {
                DayView.renderDayViewItems(dateStr);
            }
            Calendar.render(); 
            UI.closeItineraryItemModal(); 
        },
        removeItineraryItem: (dateStr, itemId) => { 
            if (!AppState.shifts[dateStr]) return;
            AppState.shifts[dateStr] = AppState.shifts[dateStr].filter(item => item.id !== itemId);
            if (AppState.shifts[dateStr].length === 0) delete AppState.shifts[dateStr]; 

            DataStorage.saveDataForCurrentMonth();
            
            if (UIElements.itineraryItemModal.style.display === 'flex' && UIElements.itineraryItemsList.dataset.date === dateStr) {
                UI.renderItineraryItemsInModal(dateStr); 
            }
            
            if (AppState.currentView === 'day' && AppState.selectedDayForDayView === dateStr) {
                DayView.renderDayViewItems(dateStr);
            }
            Calendar.render(); 

            Utils.showCustomAlert("行程項目已刪除。", "success", 1500);

            if (AppState.editingItemId === itemId) { 
                UI.closeItineraryItemModal(); 
            }
        },
        openManagementModal: () => { if (UIElements.managementModal) UIElements.managementModal.style.display = 'flex'; },
        closeManagementModal: () => { if (UIElements.managementModal) UIElements.managementModal.style.display = 'none'; },
        
        showTooltip: (event, dateStr) => { 
            if (!UIElements.dayTooltip || !UIElements.dayTooltipContent) return;
            clearTimeout(AppState.tooltipTimeout); 

            const items = AppState.shifts[dateStr] || [];
            if (items.length === 0 && !AppState.holidays[dateStr]) { 
                UI.hideTooltip(0); 
                return;
            }
            UIElements.dayTooltipContent.innerHTML = ''; 
            if (AppState.holidays[dateStr]) {
                const holidayDiv = document.createElement('div');
                holidayDiv.className = 'tooltip-item font-semibold text-orange-600';
                holidayDiv.textContent = `假期: ${AppState.holidays[dateStr]}`;
                UIElements.dayTooltipContent.appendChild(holidayDiv);
            }
            if (items.length > 0) {
                items.slice(0, 3).forEach(item => { 
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'tooltip-item';
                    let itemHTML = ""; 
                    if (item.startTime) {
                        itemHTML += `<span class="item-time">${item.startTime}</span>`;
                        if (item.endTime) itemHTML += `<span class="item-time"> - ${item.endTime}</span>`;
                        itemHTML += " ";
                    }
                    try { itemHTML += `<span class="item-description">${(typeof marked !== 'undefined' && marked.parse) ? marked.parse(item.description || "").replace(/<p>|<\/p>/g, "") : (item.description || "")}</span>`; } 
                    catch(e) { itemHTML += `<span class="item-description">${item.description || ""}</span>`;}
                    
                    if (item.location) { itemHTML += `<div class="item-location-tooltip"><i class="fas fa-map-marker-alt mr-1"></i>${item.location}</div>`; }
                    if (item.tags && item.tags.length > 0) {
                        itemHTML += `<div class="item-tags-tooltip">`;
                        item.tags.forEach(tag => { itemHTML += `<span class="tag">${tag}</span>`; });
                        itemHTML += `</div>`;
                    }
                    itemDiv.innerHTML = itemHTML;
                    UIElements.dayTooltipContent.appendChild(itemDiv);
                });
                if (items.length > 3) {
                    const moreItemsDiv = document.createElement('div');
                    moreItemsDiv.className = 'tooltip-item text-xs text-slate-500';
                    moreItemsDiv.textContent = `還有 ${items.length - 3} 個項目...`;
                    UIElements.dayTooltipContent.appendChild(moreItemsDiv);
                }
            } else if (!AppState.holidays[dateStr]) { 
                 const noItemsDiv = document.createElement('div');
                 noItemsDiv.className = 'tooltip-no-items';
                 noItemsDiv.textContent = '本日無行程項目';
                 UIElements.dayTooltipContent.appendChild(noItemsDiv);
            }
            const targetCell = event.currentTarget;
            const cellRect = targetCell.getBoundingClientRect();
            const tooltip = UIElements.dayTooltip;
            tooltip.style.display = 'block'; 
            const tooltipRect = tooltip.getBoundingClientRect();
            let top = cellRect.bottom + window.scrollY + 5; 
            let left = cellRect.left + window.scrollX;       
            if (left + tooltipRect.width > window.innerWidth) {
                left = window.innerWidth - tooltipRect.width - 10; 
            }
            if (top + tooltipRect.height > window.innerHeight && cellRect.top > tooltipRect.height + 5) {
                top = cellRect.top + window.scrollY - tooltipRect.height - 5;
            } else if (top + tooltipRect.height > window.innerHeight) {
                 top = window.innerHeight - tooltipRect.height - 10;
            }
            if (left < 0) left = 5; 
            if (top < 0) top = 5;   
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        },
        hideTooltip: (delay = 100) => { 
            if (AppState.tooltipTimeout) clearTimeout(AppState.tooltipTimeout);
            AppState.tooltipTimeout = setTimeout(() => {
                if (UIElements.dayTooltip) UIElements.dayTooltip.style.display = 'none';
            }, delay); 
        },
        openSearchResultsModal: (results) => { 
            if (!UIElements.searchResultsModal || !UIElements.searchResultsList) return;
            UIElements.searchResultsList.innerHTML = ''; 
            if (results.length === 0 && UIElements.searchInput && UIElements.searchInput.value.trim() === "") {
                 UIElements.searchResultsList.innerHTML = `
                    <div class="p-4 text-center">
                        <input type="search" id="modalSearchInput" placeholder="請在此輸入搜尋關鍵字..." class="form-input w-full mb-3">
                        <button id="modalSearchButton" type="button" class="form-button primary w-full">搜尋</button>
                    </div>`;
                const modalSearchInput = document.getElementById('modalSearchInput');
                const modalSearchButton = document.getElementById('modalSearchButton');
                if (modalSearchInput && modalSearchButton) {
                    modalSearchInput.addEventListener('keypress', (event) => {
                        if (event.key === 'Enter') {
                            UIElements.searchInput.value = modalSearchInput.value; 
                            Search.performSearch(); 
                        }
                    });
                    modalSearchButton.addEventListener('click', () => {
                        UIElements.searchInput.value = modalSearchInput.value;
                        Search.performSearch();
                    });
                    setTimeout(() => modalSearchInput.focus(), 0);
                }

            } else if (results.length === 0) {
                UIElements.searchResultsList.innerHTML = '<p class="text-slate-500 p-4 text-center">找不到符合條件的行程項目。</p>';
            } else {
                results.forEach(result => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'search-result-item';
                    let content = `<div class="search-result-date">${result.date}</div>`;
                    if (result.item.startTime) {
                        content += `<span class="item-time">${result.item.startTime}</span>`;
                        if (result.item.endTime) content += `<span class="item-time"> - ${result.item.endTime}</span>`;
                        content += " ";
                    }
                    try {
                        content += `<div class="search-result-description">${(typeof marked !== 'undefined' && marked.parse) ? marked.parse(result.item.description || "") : (result.item.description || "")}</div>`;
                    } catch (e) {
                        content += `<div class="search-result-description">${result.item.description || ""}</div>`;
                    }
                    if (result.item.location) {
                        content += `<div class="item-location-tooltip text-sm"><i class="fas fa-map-marker-alt mr-1"></i>${result.item.location}</div>`;
                    }
                    if (result.item.tags && result.item.tags.length > 0) {
                        content += `<div class="item-tags-tooltip text-sm">`;
                        result.item.tags.forEach(tag => { content += `<span class="tag">${tag}</span>`; });
                        content += `</div>`;
                    }
                    itemEl.innerHTML = content;
                    itemEl.onclick = () => {
                        UI.closeSearchResultsModal();
                        const [year, month, day] = result.date.split('-').map(Number);
                        if (AppState.currentYear !== year || AppState.currentMonth !== month -1) {
                            AppState.currentYear = year;
                            AppState.currentMonth = month - 1;
                            DataStorage.loadDataForCurrentMonth(); 
                        }
                        DayView.openDayView(result.date);
                    };
                    UIElements.searchResultsList.appendChild(itemEl);
                });
            }
            UIElements.searchResultsModal.style.display = 'flex';
        },
        closeSearchResultsModal: () => {
            if (UIElements.searchResultsModal) UIElements.searchResultsModal.style.display = 'none';
        }
    };

    // DayView Module
    const DayView = {
        openDayView: (dateStr) => {
            AppState.selectedDayForDayView = dateStr;
            UI.setActiveView('day'); 
            if (UIElements.dayViewDateTitle) {
                const [year, month, day] = dateStr.split('-');
                const d = new Date(year, parseInt(month)-1, parseInt(day));
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                UIElements.dayViewDateTitle.textContent = `${d.toLocaleDateString('zh-Hant-TW', options)} 行程`;
            }
            DayView.renderDayViewItems(dateStr);
            if (UIElements.addNewItemInDayViewButton) {
                UIElements.addNewItemInDayViewButton.onclick = () => UI.openItineraryItemModal(dateStr);
            }
        },
        closeDayView: () => {
            UI.setActiveView('calendar');
            AppState.selectedDayForDayView = null;
        },
        renderDayViewItems: (dateStr) => {
            if (!UIElements.dayViewEventsList) return;
            UIElements.dayViewEventsList.innerHTML = '';
            const items = [...(AppState.shifts[dateStr] || [])].sort((a,b) => (a.startTime || "23:59").localeCompare(b.startTime || "23:59")); 

            if (AppState.holidays[dateStr]) {
                 const holidayDiv = document.createElement('div');
                 holidayDiv.className = 'day-view-item bg-amber-50 border-amber-200'; 
                 holidayDiv.innerHTML = `<div class="item-details"><p class="item-description font-semibold text-amber-700"><i class="fas fa-star mr-2"></i>假期: ${AppState.holidays[dateStr]}</p></div>`;
                 UIElements.dayViewEventsList.appendChild(holidayDiv);
            }

            if (items.length === 0 && !AppState.holidays[dateStr]) { 
                UIElements.dayViewEventsList.innerHTML = '<p class="day-view-no-items">本日無行程項目。</p>';
                return;
            }

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'day-view-item';
                itemDiv.dataset.itemId = item.id;
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'item-details';
                if (item.startTime) {
                    const timeP = document.createElement('p');
                    timeP.className = 'item-time';
                    timeP.textContent = item.startTime + (item.endTime ? ` - ${item.endTime}` : '');
                    detailsDiv.appendChild(timeP);
                }
                const descriptionP = document.createElement('div'); 
                descriptionP.className = 'item-description';
                try {
                    descriptionP.innerHTML = (typeof marked !== 'undefined' && marked.parse) ? marked.parse(item.description || "") : (item.description || "");
                } catch(e) { descriptionP.textContent = item.description || ""; }
                detailsDiv.appendChild(descriptionP);
                if (item.location) {
                    const locationP = document.createElement('p');
                    locationP.className = 'item-location';
                    locationP.innerHTML = `<i class="fas fa-map-marker-alt mr-1"></i>${item.location}`;
                    detailsDiv.appendChild(locationP);
                }
                if (item.tags && item.tags.length > 0) {
                    const tagsDiv = document.createElement('div');
                    tagsDiv.className = 'item-tags';
                    item.tags.forEach(tag => {
                        const tagSpan = document.createElement('span');
                        tagSpan.className = 'tag';
                        tagSpan.textContent = tag;
                        tagsDiv.appendChild(tagSpan);
                    });
                    detailsDiv.appendChild(tagsDiv);
                }
                itemDiv.appendChild(detailsDiv);
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'item-actions';
                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit mr-1"></i>編輯';
                editBtn.className = 'edit-btn form-button primary text-xs'; 
                editBtn.onclick = () => UI.openItineraryItemModal(dateStr, item.id);
                actionsDiv.appendChild(editBtn);
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i>刪除';
                deleteBtn.className = 'delete-btn form-button danger text-xs'; 
                deleteBtn.onclick = () => {
                    if (confirm(`確定要刪除此行程項目嗎？\n"${item.description.substring(0,50)}..."`)) {
                        UI.removeItineraryItem(dateStr, item.id);
                    }
                };
                actionsDiv.appendChild(deleteBtn);
                itemDiv.appendChild(actionsDiv);
                UIElements.dayViewEventsList.appendChild(itemDiv);
            });
        },
        clearDay: () => {
            const dateToClear = AppState.selectedDayForDayView;
            if (!dateToClear) {
                Utils.showCustomAlert("沒有選定的日期可供清除。", "info");
                return;
            }
            if (confirm(`您確定要清除 ${dateToClear} 的所有行程項目和假期標記嗎？此操作無法復原。`)) {
                let itemsCleared = false;
                let holidayCleared = false;
                if (AppState.shifts[dateToClear] && AppState.shifts[dateToClear].length > 0) {
                    delete AppState.shifts[dateToClear];
                    itemsCleared = true;
                }
                if (AppState.holidays[dateToClear]) {
                    delete AppState.holidays[dateToClear];
                    holidayCleared = true;
                }
                if (itemsCleared || holidayCleared) {
                    DataStorage.saveDataForCurrentMonth(); 
                    DayView.renderDayViewItems(dateToClear); 
                    Calendar.render(); 
                    Utils.showCustomAlert(`${dateToClear} 的資料已成功清除。`, "success");
                } else {
                    Utils.showCustomAlert(`${dateToClear} 沒有可清除的資料。`, "info");
                }
            }
        }
    };

    // DragDrop
    const DragDrop = { 
        init: () => {
            const list = UIElements.itineraryItemsList; 
            if (list) { 
                list.addEventListener('dragstart', DragDrop.handleDragStart);
                list.addEventListener('dragover', DragDrop.handleDragOver);
                list.addEventListener('drop', DragDrop.handleDrop);
                list.addEventListener('dragend', DragDrop.handleDragEnd);
            }
        },
        handleDragStart: (e) => {
            const targetItem = e.target.closest('.itinerary-modal-item');
            if (targetItem && targetItem.dataset.itemId) {
                AppState.draggedItemId = targetItem.dataset.itemId;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', AppState.draggedItemId); 
                setTimeout(() => targetItem.classList.add('dragging'), 0); 
            } else { e.preventDefault(); }
        },
        handleDragOver: (e) => {
            e.preventDefault(); 
            e.dataTransfer.dropEffect = 'move';
            const list = UIElements.itineraryItemsList;
            if(!list) return;
            const draggingItem = list.querySelector('.dragging');
            if (!draggingItem) return;
            const siblings = [...list.querySelectorAll('.itinerary-modal-item:not(.dragging)')];
            let nextSibling = siblings.find(sibling => e.clientY < sibling.getBoundingClientRect().top + sibling.getBoundingClientRect().height / 2);
            siblings.forEach(s => s.classList.remove('drag-over'));
            if (nextSibling) { nextSibling.classList.add('drag-over');} 
        },
        handleDrop: (e) => {
            e.preventDefault();
            const dateStr = UIElements.itineraryItemsList ? UIElements.itineraryItemsList.dataset.date : null;
            if (!dateStr || !AppState.draggedItemId) return;
            const items = AppState.shifts[dateStr] || [];
            if (items.length === 0) return;
            const draggedItemIndex = items.findIndex(item => item.id === AppState.draggedItemId);
            if (draggedItemIndex === -1) return;
            const draggedItem = items.splice(draggedItemIndex, 1)[0]; 
            let targetIndex;
            const targetItemElement = e.target.closest('.itinerary-modal-item:not(.dragging)');
            if (targetItemElement && targetItemElement.dataset.itemId) {
                const targetItemId = targetItemElement.dataset.itemId;
                targetIndex = items.findIndex(item => item.id === targetItemId);
                const rect = targetItemElement.getBoundingClientRect();
                if (e.clientY >= rect.top + rect.height / 2) { targetIndex++; }
            } else {
                const list = UIElements.itineraryItemsList;
                const siblings = list ? [...list.querySelectorAll('.itinerary-modal-item:not(.dragging)')] : [];
                const nextSiblingElement = siblings.find(sibling => e.clientY < sibling.getBoundingClientRect().top + sibling.getBoundingClientRect().height / 2);
                if (nextSiblingElement && nextSiblingElement.dataset.itemId) {
                    targetIndex = items.findIndex(item => item.id === nextSiblingElement.dataset.itemId);
                } else { targetIndex = items.length; }
            }
            items.splice(targetIndex, 0, draggedItem); 
            AppState.shifts[dateStr] = items;
            DataStorage.saveDataForCurrentMonth();
            UI.renderItineraryItemsInModal(dateStr); 
            Calendar.render(); 
            if (AppState.currentView === 'day' && AppState.selectedDayForDayView === dateStr) {
                DayView.renderDayViewItems(dateStr); 
            }
        },
        handleDragEnd: (e) => {
            const targetItem = e.target.closest('.itinerary-modal-item');
            if (targetItem) targetItem.classList.remove('dragging');
            const list = UIElements.itineraryItemsList;
            if(list) { [...list.querySelectorAll('.itinerary-modal-item')].forEach(s => s.classList.remove('drag-over'));}
            AppState.draggedItemId = null;
        }
    };

    // Exporter
    const Exporter = { 
        exportItineraryToICS: () => {
            let eventsToExport = [];
            const currentMonthPrefix = `${AppState.currentYear}-${String(AppState.currentMonth + 1).padStart(2, '0')}`;
            for (const dateStr in AppState.shifts) {
                if (dateStr.startsWith(currentMonthPrefix) && AppState.shifts[dateStr]) {
                    const itemsOnDate = AppState.shifts[dateStr];
                    itemsOnDate.forEach(item => {
                        eventsToExport.push({ 
                            date: dateStr, description: item.description, id: item.id, 
                            startTime: item.startTime, endTime: item.endTime,
                            tags: item.tags, location: item.location
                        });
                    });
                }
            }
            if (eventsToExport.length === 0) { Utils.showCustomAlert("本月沒有行程表項目可供匯出。", "info"); return; }
            let icsEvents = [ 'BEGIN:VCALENDAR', 'VERSION:2.0', `PRODID:-//PersonalItineraryTool//${Utils.getLocalStorageKey('').split('_')[1]}//ZH` ];
            eventsToExport.forEach(eventData => {
                const dateParts = eventData.date.split('-'); 
                if (dateParts.length !== 3) return; 
                const year = parseInt(dateParts[0]), month = parseInt(dateParts[1]) - 1, day = parseInt(dateParts[2]); 
                let dtStartStr, dtEndStr;
                const baseDate = `${year}${String(month + 1).padStart(2, '0')}${String(day).padStart(2, '0')}`; 
                if (eventData.startTime) {
                    const startTimeStr = eventData.startTime.replace(':', '') + '00'; 
                    dtStartStr = `DTSTART;TZID=Asia/Taipei:${baseDate}T${startTimeStr}`; 
                    if (eventData.endTime) {
                        const endTimeStr = eventData.endTime.replace(':', '') + '00';
                        dtEndStr = `DTEND;TZID=Asia/Taipei:${baseDate}T${endTimeStr}`;
                    } else { 
                        const startHour = parseInt(eventData.startTime.split(':')[0]);
                        const startMinute = parseInt(eventData.startTime.split(':')[1]);
                        let endHour = startHour + 1; let endMinute = startMinute;
                        if (endHour >= 24) { endHour = 23; endMinute = 59; } 
                        dtEndStr = `DTEND;TZID=Asia/Taipei:${baseDate}T${String(endHour).padStart(2, '0')}${String(endMinute).padStart(2, '0')}00`;
                    }
                } else { 
                    dtStartStr = `DTSTART;VALUE=DATE:${baseDate}`;
                    const nextDayDate = new Date(Date.UTC(year, month, day + 1));
                    dtEndStr = `DTEND;VALUE=DATE:${nextDayDate.getUTCFullYear()}${String(nextDayDate.getUTCMonth() + 1).padStart(2, '0')}${String(nextDayDate.getUTCDate()).padStart(2, '0')}`;
                }
                let eventSummary = eventData.description.split('\n')[0]; 
                let eventDescription = eventData.description; 
                if (eventData.location) { eventDescription += `\n地點: ${eventData.location}`; }
                if (eventData.tags && eventData.tags.length > 0) { eventDescription += `\n標籤: ${eventData.tags.join(', ')}`;}
                icsEvents.push('BEGIN:VEVENT');
                icsEvents.push(`UID:itinerary-${eventData.date}-${eventData.id}@personaltool.local`); 
                icsEvents.push(`DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '').substring(0, 15)}Z`); 
                icsEvents.push(dtStartStr); icsEvents.push(dtEndStr);
                icsEvents.push(`SUMMARY:${eventSummary.replace(/\n/g, "\\n")}`); 
                icsEvents.push(`DESCRIPTION:${eventDescription.replace(/\n/g, "\\n")}`); 
                if (eventData.location) { icsEvents.push(`LOCATION:${eventData.location.replace(/\n/g, "\\n")}`);}
                icsEvents.push('END:VEVENT');
            });
            icsEvents.push('END:VCALENDAR');
            const icsContent = icsEvents.join('\r\n');
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            let filenamePart = `個人行程表_${AppState.currentYear}${String(AppState.currentMonth + 1).padStart(2, '0')}`;
            link.download = `${filenamePart}.ics`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            URL.revokeObjectURL(link.href); 
            Utils.showCustomAlert("行程表已匯出為 .ics 檔案。", "success");
        }
    };
    
    // Search Functionality
    const Search = {
        performSearch: () => {
            if (!UIElements.searchInput) return; 
            let query = UIElements.searchInput.value.trim().toLowerCase();
            const modalSearchInput = document.getElementById('modalSearchInput');
            if (UIElements.searchResultsModal.style.display === 'flex' && modalSearchInput && modalSearchInput.value.trim() !== '') {
                query = modalSearchInput.value.trim().toLowerCase();
            }

            if (!query) { 
                UI.openSearchResultsModal([]); 
                UIElements.searchResultsList.innerHTML = '<p class="text-slate-500 p-4 text-center">請輸入搜尋關鍵字。</p>';
                return;
            }
            const results = [];
            for (const dateStr in AppState.shifts) {
                if (AppState.shifts.hasOwnProperty(dateStr)) {
                    const itemsOnDate = AppState.shifts[dateStr];
                    itemsOnDate.forEach(item => {
                        let match = false;
                        if (item.description && item.description.toLowerCase().includes(query)) { match = true; }
                        if (!match && item.location && item.location.toLowerCase().includes(query)) { match = true; }
                        if (!match && item.tags && item.tags.some(tag => tag.toLowerCase().includes(query))) { match = true;}
                        if (match) { results.push({ date: dateStr, item: { ...item } }); }
                    });
                }
            }
            results.sort((a,b) => a.date.localeCompare(b.date));
            UI.openSearchResultsModal(results); 
        }
    };

    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
        UI.cacheDOMElements();
        if (UIElements.itineraryItemsList) { DragDrop.init(); } 
        DataStorage.loadDataForCurrentMonth(); 
        UI.setActiveView('calendar'); 

        if (UIElements.searchButtonNav) UIElements.searchButtonNav.addEventListener('click', () => {
            UIElements.searchInput.value = ''; 
            Search.performSearch(); 
        });
        if (UIElements.todayButtonNav) UIElements.todayButtonNav.addEventListener('click', Calendar.goToToday);
        if (UIElements.openManagementModalButtonNav) UIElements.openManagementModalButtonNav.addEventListener('click', UI.openManagementModal);

        if (UIElements.saveNotesButton) {
            UIElements.saveNotesButton.addEventListener('click', () => {
                if (UIElements.scheduleNotesTextarea) AppState.notes = UIElements.scheduleNotesTextarea.value;
                DataStorage.saveDataForCurrentMonth();
                Utils.showCustomAlert("備註已儲存。", "success", 2000);
            });
        }
        if (UIElements.closeManagementModalButton) UIElements.closeManagementModalButton.addEventListener('click', UI.closeManagementModal);
        
        if (UIElements.saveItineraryButton) { 
            UIElements.saveItineraryButton.addEventListener('click', () => {
                if (UIElements.scheduleNotesTextarea) AppState.notes = UIElements.scheduleNotesTextarea.value; 
                DataStorage.saveDataForCurrentMonth();
                Utils.showCustomAlert("行程表資料已儲存。", "success");
                UI.closeManagementModal();
            });
        }
        if (UIElements.clearItineraryButton) { 
            UIElements.clearItineraryButton.addEventListener('click', () => {
                if (confirm(`您確定要清除 ${AppState.currentYear}年 ${AppState.currentMonth + 1}月 的所有行程表資料和備註嗎？此操作無法復原。`)) {
                    DataStorage.clearCurrentMonthItinerary();
                }
            });
        }
        if (UIElements.addOrUpdateItineraryItemButton) UIElements.addOrUpdateItineraryItemButton.addEventListener('click', UI.addOrUpdateItineraryItem);
        if (UIElements.closeItineraryItemModalButton) UIElements.closeItineraryItemModalButton.addEventListener('click', UI.closeItineraryItemModal);
        if (UIElements.timeSettingToggle) UIElements.timeSettingToggle.addEventListener('click', () => UI.toggleTimeSetting());
        
        if (UIElements.newItineraryItemText) { 
             UIElements.newItineraryItemText.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); 
                    UI.addOrUpdateItineraryItem();
                }
            });
        }
        if (UIElements.closeSearchResultsModalButton) UIElements.closeSearchResultsModalButton.addEventListener('click', UI.closeSearchResultsModal);

        if (UIElements.backToCalendarViewButton) UIElements.backToCalendarViewButton.addEventListener('click', DayView.closeDayView);
        if (UIElements.resetDayButton) UIElements.resetDayButton.addEventListener('click', DayView.clearDay); 

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (UIElements.itineraryItemModal && UIElements.itineraryItemModal.style.display === 'flex') UI.closeItineraryItemModal();
                if (UIElements.managementModal && UIElements.managementModal.style.display === 'flex') UI.closeManagementModal();
                if (UIElements.searchResultsModal && UIElements.searchResultsModal.style.display === 'flex') UI.closeSearchResultsModal();
                UI.hideTooltip(0); 
            }
        });
        window.onclick = function(event) { 
            if (UIElements.itineraryItemModal && event.target == UIElements.itineraryItemModal) UI.closeItineraryItemModal();
            if (UIElements.managementModal && event.target == UIElements.managementModal) UI.closeManagementModal();
            if (UIElements.searchResultsModal && event.target == UIElements.searchResultsModal) UI.closeSearchResultsModal();
        }
        
        if(UIElements.calendarGrid) UIElements.calendarGrid.addEventListener('mouseleave', () => UI.hideTooltip());
        window.addEventListener('blur', () => UI.hideTooltip(0)); 
    });
    </script>
</body>
</html>
<div style="text-align: center;">
 Copyright © Jean Giono 
</div>
